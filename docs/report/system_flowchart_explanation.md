# 資源回収ルート最適化システム - フロー図説明書

## 📋 概要

本ドキュメントは、資源回収ルート最適化システムのフロー図（`system_flowchart.svg`）の詳細説明です。
第三者が理解しやすいように、システムの全体像、データフロー、処理手順を解説します。

---

## 🎯 システムの目的

資源回収業務における以下の最適化を実現します：

1. **コスト最小化**: 固定費・変動費の総コストを最小化
2. **効率化**: 最短ルートで全回収地点を巡回
3. **環境配慮**: エネルギー消費量（CO2排出量）の削減
4. **意思決定支援**: 視覚的なルート表示と詳細なコスト分析

---

## 📥 入力データ

### 1. 道路ネットワークデータ
**ファイル**: `data/road_network_YYYYMMDD_HHMMSS.json`

**内容**:
- **ノード情報**: 地点ID、緯度・経度、地点名
- **エッジ情報**: 道路の接続関係、距離、道路種別
- **メタデータ**: ノード数、エッジ数、データ作成日時

**役割**: 実際の道路ネットワーク上での最短経路計算の基盤

### 2. マスタデータ
**ディレクトリ**: `data/processed/`

**構成**:
- `resources.json`: 資源種別（紙、プラスチック等）とその特性
  - 嵩密度、ゲート料、処理方法、制約条件
- `vehicles.json`: 車種情報
  - 積載容量、年間固定費、変動費単価、エネルギー消費原単位
- `compatibility.json`: 資源と車種の適合性マトリクス
  - どの車種がどの資源を運搬可能か

**役割**: 現実的な制約条件の設定

### 3. ユーザー選択情報
**入力方法**: 地図上のクリック操作、入力フォーム

**内容**:
- **車庫地点**: 車両の出発・帰着地点
- **回収地点**: 資源回収する地点（複数）
  - 各地点の資源種別
  - 各地点の回収量[kg]
- **集積場所**: 回収した資源を集める終点

**役割**: 最適化対象の具体的な問題定義

---

## 💾 データ格納層

システム内部で保持するデータ構造：

### 1. NetworkX グラフ
- **形式**: 有向グラフ（DiGraph）
- **内容**: ノードとエッジの関係性、属性情報
- **用途**: 最短経路探索アルゴリズムの実行基盤

### 2. 地点レジストリ（PointRegistry）
- **管理対象**: 車庫、回収地点、集積場所
- **属性**: 位置情報、地点タイプ、回収量、資源種別
- **用途**: 最適化処理での地点情報の一元管理

### 3. 車種カタログ（VehicleCatalog）
- **管理対象**: 利用可能な車種のリスト
- **属性**: 容量、コスト構造、エネルギー消費特性
- **用途**: 車種選択と費用計算

### 4. 距離行列
- **形式**: N×N 行列（N = 地点数）
- **内容**: 全地点間の最短距離[m]
- **用途**: ルート最適化での距離計算の高速化

### 5. 空間インデックス（SpatialIndex）
- **構造**: 地理座標の空間分割データ構造
- **用途**: 地図クリック時の最寄りノード高速検索

---

## ⚙️ 処理フロー

### 処理1: データ読込・初期化

**入力**: JSONファイル
**処理内容**:
1. 道路ネットワークJSONの読込
2. NetworkXグラフへの変換
3. マスタデータの読込とパース
4. セッション状態の初期化
5. キャッシュの構築（高速化のため）

**出力**: システム内データ構造の準備完了

---

### 処理2: 地点選択（UI操作）

**入力**: ユーザーの地図クリック、入力フォーム
**処理内容**:
1. 地図上のクリック位置（緯度・経度）取得
2. 空間インデックスで最寄りノードを検索
3. モードに応じて地点を分類（車庫/回収/集積）
4. 回収地点の場合、ダイアログで資源種別・量を入力
5. 選択状態をセッションに保存

**出力**: 選択済み地点リスト、属性情報

**UI機能**:
- インタラクティブ地図（Folium）
- 地点選択モード切替（ラジオボタン）
- 回収地点入力ダイアログ
- 選択状況のリアルタイム表示

---

### 処理3: 車種割当プラン生成

**入力**: 回収地点リスト、資源種別情報、車種カタログ
**処理内容**:
1. 各資源種別ごとに必要な回収地点を分類
2. 適合性マトリクスで対応可能な車種を抽出
3. コスト評価関数で最適な車種を選択
4. 複数資源の場合、車種ごとに担当資源を割当
5. 警告メッセージの生成（適合車種なし等）

**出力**: 車種割当プラン、警告リスト

**アルゴリズム**:
- 単一車種で全資源対応可能 → その車種を選択
- 複数車種必要 → 資源ごとに最小コスト車種を選択

---

### 処理4: 距離行列計算

**入力**: NetworkXグラフ、選択地点リスト
**処理内容**:
1. 地点間の全組合せについて最短経路探索
2. NetworkX の `shortest_path_length` 使用
3. 距離[m]を行列形式で保存
4. キャッシュに保存（同一地点セットの再計算回避）

**出力**: 距離行列（N×N）

**計算量**: O(N³) - ダイクストラ法の繰り返し

---

### 処理5: ルート最適化

**入力**: 距離行列、車種割当プラン、地点属性
**処理内容**:
1. 各車種について独立にVRPを解く
2. 車庫 → 回収地点群 → 集積場所 の順序最適化
3. 容量制約を考慮した訪問順序の決定
4. 総移動距離の最小化

**出力**: 最適訪問順序、総距離

**アルゴリズム**: 貪欲法ベースのヒューリスティック
- 近傍優先探索
- 容量制約チェック
- 局所最適化による改善

---

### 処理6: コスト詳細計算

**入力**: 最適ルート、走行距離、車種情報
**処理内容**:
1. **固定費計算**:
   - 各固定費項目（人件費、車両償却費等）を取得
   - km単価 = 年間費用 ÷ 年間走行距離
   - 固定費 = km単価 × 走行距離
2. **変動費計算**:
   - 各変動費項目（燃料費、修繕費等）を取得
   - 変動費 = 単価[円/km] × 走行距離
3. **エネルギー消費量計算**:
   - 消費量[kWh] = 原単位[kWh/km] × 走行距離
4. **総コスト計算**:
   - 総コスト = Σ固定費 + Σ変動費

**出力**: コスト詳細内訳辞書

**計算式**:
```
総コスト = 固定費 + 変動費
固定費 = Σᵢ (年間固定費ᵢ / 年間走行距離 × 走行距離)
変動費 = Σⱼ (距離単価ⱼ × 走行距離)
エネルギー = 消費原単位 × 走行距離
```

---

### 処理7: 経路再構成

**入力**: 最適訪問順序、NetworkXグラフ
**処理内容**:
1. 訪問順序に従って地点間の詳細経路を取得
2. NetworkX の `shortest_path` で座標列を取得
3. 地図表示用のPolyLine座標リストを生成

**出力**: 経路座標リスト（Folium用）

**データ形式**: `[[(lat1, lon1), (lat2, lon2), ...], [...], ...]`

---

### 処理8: 結果可視化

**入力**: 経路座標リスト、地点情報、コスト詳細
**処理内容**:
1. **地図表示**:
   - Foliumでインタラクティブ地図を生成
   - 経路をPolyLineで描画（青線）
   - 地点をCircleMarkerで表示（色分け）
   - 訪問順序を番号表示
2. **コスト表示**:
   - 総距離、総コスト、エネルギー消費量をメトリクス表示
   - 詳細内訳をテーブル表示
   - 計算式の表示（LaTeX）
3. **ルート情報表示**:
   - 訪問順序のリスト
   - 使用車種の情報

**出力**: Streamlit UIコンポーネント

---

## 📤 出力結果

### 1. 最適ルート情報
- 訪問順序（地点ID列）
- 総走行距離[km]
- 使用車種名

### 2. コスト詳細内訳
- **固定費**（項目別）
  - 人件費、車両償却費、保険料等
- **変動費**（項目別）
  - 燃料費、タイヤ代、修繕費等
- **総コスト**

### 3. エネルギー消費量
- 総消費電力量[kWh]
- 車両別消費量
- CO2削減効果（EV化の場合）

### 4. 地図上の可視化
- インタラクティブ地図（ズーム・パン可能）
- ルート経路（青線）
- 地点マーカー（色分け）
  - 緑: 車庫（出発/帰着）
  - 青: 回収地点
  - 赤: 集積場所
- 訪問順序番号

---

## 🔧 主要技術スタック

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| Webフレームワーク | Streamlit | UIの構築、インタラクティブ操作 |
| グラフ処理 | NetworkX | 道路ネットワーク解析、最短経路計算 |
| 地図表示 | Folium + streamlit-folium | インタラクティブ地図の表示 |
| データ処理 | Pandas | テーブル編集、データ整形 |
| 言語 | Python 3.8+ | システム全体の実装 |

---

## 📊 システムの特徴

### ✅ 長所
1. **直感的な操作**: 地図クリックで簡単に地点選択
2. **自動最適化**: 複雑な計算をバックグラウンドで実行
3. **詳細な分析**: コスト内訳を項目別に表示
4. **柔軟性**: 複数車種、複数資源種別に対応
5. **視覚的**: 地図上でルートを確認可能
6. **セッション保持**: ページ再読込後も状態維持

### ⚠️ 制約事項
1. **計算時間**: 地点数が多いと最適化に時間がかかる
2. **最適性**: ヒューリスティックのため厳密解ではない
3. **データ依存**: 道路ネットワークの精度に依存
4. **単一日程**: 複数日のスケジューリングは非対応

---

## 👥 想定ユーザー

1. **自治体の資源回収担当者**
   - 回収ルートの計画立案
   - コスト削減策の検討

2. **廃棄物処理業者の配送計画担当者**
   - 効率的な配送計画の作成
   - 車両運用の最適化

3. **環境コンサルタント**
   - CO2削減効果の試算
   - EV導入効果の分析

4. **ロジスティクス最適化の研究者**
   - VRPアルゴリズムの評価
   - 実データでの検証

---

## 📐 最適化アルゴリズム詳細

### 問題定義
**VRP (Vehicle Routing Problem)** の変種:
- **目的関数**: 総コストの最小化
- **制約条件**:
  - 各回収地点を必ず1回訪問
  - 車両容量を超えない
  - 車庫から出発し、集積場所で終了
  - 資源と車種の適合性を満たす

### アルゴリズム
1. **初期解生成**: 近傍優先の貪欲法
2. **局所最適化**: 2-opt法による改善
3. **車種選択**: コスト評価関数による最適化

### 計算量
- **時間計算量**: O(N² × M)
  - N: 地点数
  - M: 車種数
- **空間計算量**: O(N²)
  - 距離行列の保存

---

## 🔄 データフロー概要

```
[JSONファイル] → [読込] → [グラフ構築] → [キャッシュ]
                                ↓
[ユーザー入力] → [地点選択] → [車種割当] → [距離行列計算]
                                ↓
                          [ルート最適化]
                                ↓
                    [コスト計算・経路再構成]
                                ↓
                    [地図表示・結果出力]
```

---

## 📝 使用例

### シナリオ: 市内3箇所の資源回収

1. **初期設定**
   - 道路ネットワーク: 市内全域
   - 資源: 紙、プラスチック
   - 車種: 小型EV（容量500kg）、大型トラック（容量1500kg）

2. **地点選択**
   - 車庫: 清掃事務所
   - 回収地点A: 紙 300kg
   - 回収地点B: プラスチック 400kg
   - 回収地点C: 紙 200kg
   - 集積場所: リサイクルセンター

3. **実行結果**
   - 最適ルート: 車庫 → A → C → B → 集積場所
   - 使用車種: 小型EV × 1台
   - 総距離: 18.5 km
   - 総コスト: 2,220円
   - エネルギー消費: 3.7 kWh
   - CO2削減: 8.1 kg（ガソリン車比）

---

## 🎨 地図表示の凡例

| 色 | 地点タイプ | 意味 |
|----|----------|------|
| 🟢 緑 | 車庫 | 出発・帰着地点 |
| 🔵 青 | 回収地点 | 資源を回収する地点 |
| 🔴 赤 | 集積場所 | 回収物を集める終点 |
| 🟡 黄枠 | 最新選択 | 直前に操作した地点 |
| 🔵 青線 | 経路 | 最適化されたルート |

---

## 📈 性能指標

### レスポンス時間（目安）
- データ読込: ~1秒
- 地図表示: ~2秒
- 距離行列計算: ~3秒（10地点の場合）
- ルート最適化: ~1秒（10地点、2車種の場合）

### スケーラビリティ
- **推奨地点数**: ~20地点以内
- **最大地点数**: ~50地点（計算時間 ~30秒）
- **道路ネットワーク**: ~10,000ノードまで対応

---

## 🛠️ 運用上の注意点

1. **データ準備**
   - 道路ネットワークJSONは事前に作成が必要
   - マスタデータは最新の情報に更新すること

2. **入力チェック**
   - 車庫と集積場所は必ず異なる地点を選択
   - 回収地点は最低1箇所必要
   - 資源種別は全地点で設定必須

3. **結果の解釈**
   - 表示されるコストは走行距離ベース（他の要因は未考慮）
   - 最適化はヒューリスティックのため、必ずしも厳密解ではない
   - 実運用時は交通状況等の追加考慮が必要

---

## 📚 関連ドキュメント

- `docs/design.md`: 設計書
- `docs/20251023_総コスト算出システム全体分析.md`: コスト計算詳細
- `docs/20251118_054956_エネルギー消費量追加_詳細設計書.md`: エネルギー機能設計

---

## 📞 サポート

システムに関する質問や改善要望は、プロジェクト管理者までお問い合わせください。

---

**作成日**: 2025-11-28
**バージョン**: 1.0
**対象システム**: 資源回収ルート最適化システム
