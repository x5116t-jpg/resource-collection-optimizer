# 総コスト算出システム全体分析

**作成日**: 2025-10-23
**対象システム**: 資源回収ルート最適化ツール

---

## 1. エグゼクティブサマリー

本ドキュメントは、資源回収ルート最適化ツールにおける**総コスト算出の全体フロー**を分析したものです。

### 1.1 コスト算出の基本構造

総コストは以下の式で算出されます：

```
総コスト = 変動費 + 固定費
```

**変動費**:
- 走行距離に比例するコスト（燃料費、人件費など13項目）
- 計算式: `Σ(単価_i × 走行距離)`

**固定費**:
- 年間固定費を走行距離で按分したコスト（減価償却費、保険など12項目）
- 計算式: `Σ((年間費用_i / 年間走行距離) × 走行距離)`

### 1.2 データフロー概要

```
vehicles.json (25項目)
    ↓
VehicleCandidate (詳細保持)
    ↓
VehicleType (最適化用)
    ↓
_evaluate_cost() (cost_breakdown生成)
    ↓
Solution/FleetSolution (結果)
    ↓
UI表示 (詳細テーブル)
```

---

## 2. データソース層: vehicles.json

### 2.1 ファイル構造

**場所**: `data/processed/vehicles.json`

各車両エントリには以下の情報が含まれます：

```json
{
  "name": "軽トラック",
  "capacity_kg": 350.0,
  "annual_distance_km": 20000.0,

  "variable_cost_per_km": 321.0,
  "variable_cost_breakdown": {
    "燃料費_円_per_km": 12.0,
    "運転手人件費_円_per_km": 47.0,
    "高速料金_円_per_km": 27.5,
    "タイヤ交換費_円_per_km": 2.0,
    "修理費_円_per_km": 4.0,
    "作業時間人件費_15km_円_per_km": 100.0,
    "作業時間人件費_30km_円_per_km": 50.0,
    "作業時間人件費_40km_円_per_km": 37.5,
    "補助員人件費_円_per_km": 0.0,
    "回収容器費_円_per_km": 6.5,
    "消耗品費_円_per_km": 2.5,
    "通信費_円_per_km": 3.0,
    "マニフェスト費用_円_per_km": 4.0,
    "処理費_参考値_円_per_km": 25.0
  },

  "annual_fixed_cost": 1882000.0,
  "fixed_cost_per_km": 94.1,
  "fixed_cost_breakdown": {
    "減価償却費_万円_per_年": 12.5,
    "自動車税_万円_per_年": 0.4,
    "重量税_万円_per_年": 0.2,
    "自賠責保険_万円_per_年": 0.5,
    "任意保険_万円_per_年": 3.25,
    "車検費用_万円_per_年": 2.0,
    "定期点検費用_万円_per_年": 1.25,
    "車庫賃料_万円_per_年": 9.0,
    "許認可費用_万円_per_年": 2.0,
    "システム利用料_万円_per_年": 3.0,
    "福利厚生費_万円_per_年": 10.0,
    "社会保険料_万円_per_年": 50.0
  }
}
```

### 2.2 重要なフィールド

| フィールド | 型 | 説明 |
|----------|-----|------|
| `variable_cost_per_km` | float | 変動費合計（円/km） |
| `variable_cost_breakdown` | Dict[str, float] | 変動費詳細13項目（円/km） |
| `annual_fixed_cost` | float | 年間固定費合計（円） |
| `fixed_cost_per_km` | float | 固定費のkm単価（円/km） |
| `fixed_cost_breakdown` | Dict[str, float] | 固定費詳細12項目（万円/年） |
| `annual_distance_km` | float | 年間走行距離（km） |

### 2.3 単位の注意点

- **変動費**: すべて `円/km`
- **固定費**: すべて `万円/年`（計算時に円換算が必要）
- **年間固定費**: `円`

---

## 3. データモデル層

### 3.1 VehicleCandidate (master_repository.py)

**役割**: vehicles.jsonから読み込んだ詳細データを保持

```python
@dataclass(frozen=True)
class VehicleCandidate:
    name: str
    capacity_kg: Optional[float]
    variable_cost_per_km: float
    fixed_cost_per_km: float
    annual_fixed_cost: float
    variable_cost_breakdown: Dict[str, float]  # 13項目
    fixed_cost_breakdown: Dict[str, float]     # 12項目
    annual_distance_km: Optional[float]
    # ... その他のメタデータ
```

**特徴**:
- 詳細な内訳情報（25項目）を完全保持
- optimizer.pyでcost_breakdown生成時に使用
- 最適化計算自体には直接使用されない

### 3.2 VehicleType (vehicle_catalog.py)

**役割**: 最適化計算用の軽量な車両モデル

```python
@dataclass(frozen=True)
class VehicleType:
    name: str
    capacity_kg: int
    fixed_cost: float              # 基本固定費（通常0.0）
    per_km_cost: float             # 変動費単価（円/km）
    fixed_cost_per_km: float       # 固定費単価（円/km）

    def distance_cost(self, distance_m: float) -> float:
        """変動費を計算"""
        return self.per_km_cost * (distance_m / 1000.0)

    def fixed_cost_for_distance(self, distance_m: float) -> float:
        """固定費を計算"""
        return self.fixed_cost + self.fixed_cost_per_km * (distance_m / 1000.0)
```

**特徴**:
- 最適化に必要な最小限のフィールドのみ
- 詳細内訳情報は保持しない
- 高速な比較とコスト計算が可能

### 3.3 VehicleCandidateからVehicleTypeへの変換

**場所**: `app.py:_generate_vehicle_defaults()`

```python
def _generate_vehicle_defaults(master: Optional[ProcessedMasterData]):
    vehicles: List[Dict[str, float]] = []
    metadata: Dict[str, Dict[str, float]] = {}

    for candidate in master.vehicles:
        # VehicleType用のデータ
        vehicles.append({
            "name": candidate.name,
            "capacity_kg": int(candidate.capacity_kg),
            "fixed_cost": 0.0,  # ★常に0（距離按分で評価）
            "per_km_cost": candidate.variable_cost_per_km,
        })

        # 詳細データはmetadataとしてsession_stateに保存
        metadata[candidate.name] = {
            "annual_fixed_cost": candidate.annual_fixed_cost,
            "fixed_cost_per_km": candidate.fixed_cost_per_km,
            "variable_cost_per_km": candidate.variable_cost_per_km,
        }

    return vehicles, metadata
```

**重要ポイント**:
1. `fixed_cost`は常に**0.0**に設定
   - 理由: 年間固定費は`fixed_cost_per_km`で距離按分評価するため
2. `per_km_cost`は`variable_cost_per_km`をそのまま使用
3. 詳細内訳は`metadata`としてsession_stateに保存

---

## 4. コスト計算層: optimizer.py

### 4.1 _evaluate_cost() 関数

**役割**: 走行距離と車両情報から詳細なcost_breakdownを生成

```python
def _evaluate_cost(
    vehicle: VehicleType,
    distance_m: float,
    vehicle_metadata: Optional[VehicleCandidate] = None
) -> Dict[str, float]:
```

#### 4.1.1 基本コスト計算（既存ロジック）

```python
distance_km = distance_m / 1000.0

# VehicleTypeのメソッドを使用
variable_cost = vehicle.distance_cost(distance_m)
    # = vehicle.per_km_cost * distance_km

fixed_cost = vehicle.fixed_cost_for_distance(distance_m)
    # = vehicle.fixed_cost + vehicle.fixed_cost_per_km * distance_km
    # = 0.0 + vehicle.fixed_cost_per_km * distance_km

total_cost = fixed_cost + variable_cost

result = {
    "fixed_cost": int(fixed_cost),
    "distance_cost": int(variable_cost),
    "total_cost": int(total_cost),
    "distance_km": distance_km,
}
```

**計算例**（軽トラック、45.5km走行）:
```
variable_cost = 321.0 × 45.5 = 14,605.5 → 14,605円（切り捨て）
fixed_cost = 0.0 + 94.1 × 45.5 = 4,281.55 → 4,281円（切り捨て）
total_cost = 4,281 + 14,605 = 18,886円
```

#### 4.1.2 詳細コスト計算（新規ロジック）

**変動費詳細** (13項目):

```python
if vehicle_metadata and vehicle_metadata.variable_cost_breakdown:
    for item_name, unit_cost in vehicle_metadata.variable_cost_breakdown.items():
        key = f"変動費_{item_name}"
        result[key] = int(float(unit_cost) * distance_km)
```

**計算例**（燃料費、45.5km）:
```
燃料費 = 12.0 × 45.5 = 546.0 → 546円
```

**固定費詳細** (12項目):

```python
if vehicle_metadata and vehicle_metadata.fixed_cost_breakdown:
    if vehicle_metadata.annual_distance_km > 0:
        for item_name, annual_manyen in vehicle_metadata.fixed_cost_breakdown.items():
            # 万円 → 円 変換
            annual_yen = float(annual_manyen) * 10000

            # km単価計算
            per_km = annual_yen / vehicle_metadata.annual_distance_km

            # この走行距離での費用
            key = f"固定費_{item_name}"
            result[key] = int(per_km * distance_km)
```

**計算例**（減価償却費、軽トラック、45.5km）:
```
年間減価償却費 = 12.5万円 = 125,000円
km単価 = 125,000 / 20,000 = 6.25円/km
この走行での費用 = 6.25 × 45.5 = 284.375 → 284円
```

#### 4.1.3 完全なcost_breakdown構造

```python
{
    # 基本情報（4項目）
    "fixed_cost": 4281,           # 固定費合計
    "distance_cost": 14605,       # 変動費合計
    "total_cost": 18886,          # 総コスト
    "distance_km": 45.5,          # 走行距離

    # 変動費詳細（13項目）
    "変動費_燃料費_円_per_km": 546,
    "変動費_運転手人件費_円_per_km": 2138,
    "変動費_高速料金_円_per_km": 1251,
    # ... 他10項目

    # 固定費詳細（12項目）
    "固定費_減価償却費_万円_per_年": 284,
    "固定費_自動車税_万円_per_年": 9,
    "固定費_重量税_万円_per_年": 4,
    # ... 他9項目
}
```

**合計**: 4 + 13 + 12 = **29項目**

### 4.2 小数点処理

すべてのコスト値は`int()`で**切り捨て**処理されます：

```python
result[key] = int(float(value))  # 小数点以下切り捨て
```

**理由**: ユーザー要求「コストの小数点以下は不要ですので切り捨ててください」

---

## 5. 最適化実行層

### 5.1 単一車両最適化: solve_routing()

```python
def solve_routing(
    distance_matrix: DistanceMatrix,
    pickups: Sequence[PickupInput],
    depot: str,
    sink: str,
    vehicles: Union[Iterable[VehicleType], VehicleType],
    vehicle_metadata_map: Optional[Dict[str, VehicleCandidate]] = None,
) -> Union[Solution, NoSolution]:
```

**フロー**:
1. OR-Tools または fallback heuristic でルート最適化
2. 最適ルートの総距離を計算
3. 各候補車両について：
   - `metadata = vehicle_metadata_map.get(vehicle.name)`
   - `breakdown = _evaluate_cost(vehicle, total_distance, metadata)`
   - コストが最小の車両を選択
4. `Solution`オブジェクトを返す

### 5.2 フリート最適化: solve_fleet_routing()

```python
def solve_fleet_routing(
    distance_matrix: DistanceMatrix,
    depot: str,
    sink: str,
    assignments: Sequence[Tuple[VehicleType, Sequence[PickupInput]]],
    vehicle_metadata_map: Optional[Dict[str, VehicleCandidate]] = None,
) -> Union[FleetSolution, NoSolution]:
```

**フロー**:
1. 各車両割り当てについて：
   - `solve_routing()`を呼び出し
   - `VehicleRoute`を生成
2. **コスト集計**:
   ```python
   totals: Dict[str, float] = defaultdict(float)

   for key, value in result.cost_breakdown.items():
       totals[key] += float(value)
   ```
3. 基本3項目の整合性確保:
   ```python
   totals.setdefault("fixed_cost", 0.0)
   totals.setdefault("distance_cost", 0.0)
   totals.setdefault("total_cost", totals["fixed_cost"] + totals["distance_cost"])
   ```
4. `FleetSolution`を返す

**集計の特徴**:
- すべてのcost_breakdownキーを自動集計
- 詳細内訳（変動費13項目、固定費12項目）も自動的に合算される
- フリート全体の詳細内訳が得られる

---

## 6. UI表示層: app.py

### 6.1 vehicle_metadata_mapの構築

**場所**: `app.py:1588-1593行`

```python
# vehicle_metadata_mapの作成
vehicle_metadata_map: Dict[str, VehicleCandidate] = {}
processed_master = st.session_state.get("processed_master")
if processed_master and processed_master.vehicles:
    for candidate in processed_master.vehicles:
        vehicle_metadata_map[candidate.name] = candidate
```

**タイミング**: 最適化実行直前

### 6.2 表示関数の統合

#### 単一車両表示: _display_single_solution()

```python
def _display_single_solution(graph, solution: Solution, ...):
    # ... 基本情報表示 ...

    # 基本コスト内訳テーブル（3項目）
    breakdown_rows = [
        {"項目": "固定費", "金額": solution.cost_breakdown.get("fixed_cost", 0.0)},
        {"項目": "距離費", "金額": solution.cost_breakdown.get("distance_cost", 0.0)},
        {"項目": "総額", "金額": solution.cost_breakdown.get("total_cost", 0.0)},
    ]
    st.table(pd.DataFrame(breakdown_rows))

    # 詳細コスト内訳の表示（新規）
    _display_detailed_cost_breakdown(solution.cost_breakdown, solution.vehicle.name)
```

#### フリート表示: _display_fleet_solution()

```python
def _display_fleet_solution(graph, fleet_solution: FleetSolution, ...):
    # ... フリート全体のサマリー ...

    # フリート全体の詳細コスト内訳表示（新規）
    if fleet_solution.routes:
        _display_detailed_cost_breakdown(fleet_solution.cost_breakdown, "フリート全体")

    # 各車両の詳細表示
    for route in fleet_solution.routes:
        _display_single_solution(graph, route.solution, ...)
```

### 6.3 詳細内訳表示: _display_detailed_cost_breakdown()

```python
def _display_detailed_cost_breakdown(
    cost_breakdown: Dict[str, float],
    vehicle_name: str
) -> None:
    # 詳細データの有無チェック
    has_variable_details = any(k.startswith("変動費_") for k in cost_breakdown.keys())
    has_fixed_details = any(k.startswith("固定費_") for k in cost_breakdown.keys())

    if not has_variable_details and not has_fixed_details:
        st.info("💡 詳細内訳データがありません（基本表示モード）")
        return

    # 垂直レイアウトで3セクション表示
    _display_variable_cost_table(...)    # 変動費詳細
    _display_fixed_cost_table(...)       # 固定費詳細
    _display_cost_formula(...)           # 計算式
```

---

## 7. 総コスト算出の完全フロー

### 7.1 データ準備フェーズ

```
1. vehicles.json読み込み
   ↓
2. VehicleCandidateオブジェクト生成
   - 25項目の詳細データを保持
   ↓
3. _generate_vehicle_defaults()
   - vehicles: VehicleType用データ（簡略版）
   - metadata: session_stateに保存
   ↓
4. VehicleCatalog構築
   - VehicleTypeオブジェクト生成
   - fixed_cost = 0.0
   - per_km_cost = variable_cost_per_km
   - fixed_cost_per_km = metadataから取得
```

### 7.2 最適化実行フェーズ

```
5. vehicle_metadata_map構築
   - Dict[車両名, VehicleCandidate]
   ↓
6. solve_routing() / solve_fleet_routing()
   - ルート最適化
   - 総走行距離計算
   ↓
7. _evaluate_cost()
   入力:
   - vehicle: VehicleType（最適化で選択された車両）
   - distance_m: 総走行距離（メートル）
   - vehicle_metadata: VehicleCandidate（詳細データ）

   処理:
   a) 基本コスト計算
      variable_cost = vehicle.per_km_cost × distance_km
      fixed_cost = vehicle.fixed_cost_per_km × distance_km
      total_cost = variable_cost + fixed_cost

   b) 変動費詳細計算（13項目）
      各項目 = 単価(円/km) × distance_km

   c) 固定費詳細計算（12項目）
      km単価 = (年間費用 × 10000) / annual_distance_km
      各項目 = km単価 × distance_km

   d) すべての値をint()で切り捨て

   出力:
   - cost_breakdown（29項目の辞書）
```

### 7.3 集計フェーズ（フリートの場合）

```
8. solve_fleet_routing()での集計
   totals = defaultdict(float)

   for each route:
       for key, value in route.cost_breakdown.items():
           totals[key] += value

   → フリート全体の29項目が集計される
```

### 7.4 表示フェーズ

```
9. UI表示
   a) 基本テーブル（3項目）
      - 固定費
      - 距離費
      - 総額

   b) 詳細内訳（26項目）
      - 変動費詳細テーブル（13項目）
      - 固定費詳細テーブル（12項目）
      - 計算式表示
      - 距離情報
```

---

## 8. コスト計算の数式整理

### 8.1 変動費の計算

```
変動費合計 = Σ(変動費項目_i)

変動費項目_i = 単価_i(円/km) × 走行距離(km)
```

**具体例**（軽トラック、45.5km）:
```
燃料費 = 12.0 × 45.5 = 546円
運転手人件費 = 47.0 × 45.5 = 2,138円
高速料金 = 27.5 × 45.5 = 1,251円
...（全13項目）

変動費合計 = 546 + 2,138 + 1,251 + ... = 14,605円
```

### 8.2 固定費の計算

```
固定費合計 = Σ(固定費項目_i)

固定費項目_i = km単価_i × 走行距離(km)

km単価_i = (年間費用_i(万円) × 10,000) / 年間走行距離(km)
```

**具体例**（軽トラック、45.5km）:
```
減価償却費:
  年間 = 12.5万円 = 125,000円
  km単価 = 125,000 / 20,000 = 6.25円/km
  この走行 = 6.25 × 45.5 = 284円

自動車税:
  年間 = 0.4万円 = 4,000円
  km単価 = 4,000 / 20,000 = 0.2円/km
  この走行 = 0.2 × 45.5 = 9円

...（全12項目）

固定費合計 = 284 + 9 + ... = 4,281円
```

### 8.3 総コストの計算

```
総コスト = 変動費合計 + 固定費合計

総コスト = 14,605 + 4,281 = 18,886円
```

### 8.4 検証

vehicles.jsonの値と比較：

```
変動費合計（直接計算）:
  variable_cost_per_km × distance_km
  = 321.0 × 45.5 = 14,605.5 → 14,605円 ✓

固定費合計（直接計算）:
  fixed_cost_per_km × distance_km
  = 94.1 × 45.5 = 4,281.55 → 4,281円 ✓

詳細内訳の合計値と一致することを確認
```

---

## 9. データの完全性と一貫性

### 9.1 データの流れと情報損失

```
vehicles.json (25項目)
    ↓ 完全保持
VehicleCandidate (25項目)
    ↓ 最適化用に簡略化
VehicleType (5項目)  ← 情報損失発生
    ↓ 詳細情報を再結合
_evaluate_cost() + VehicleCandidate
    ↓ 完全復元
cost_breakdown (29項目 = 基本4 + 詳細25)
```

**重要**:
- VehicleTypeは最適化計算用の軽量モデル
- 詳細情報はVehicleCandidateで保持
- _evaluate_cost()で詳細情報を再結合

### 9.2 一貫性の保証

**検証ポイント**:
1. **合計値の一致**:
   ```python
   Σ(変動費詳細13項目) ≈ distance_cost
   Σ(固定費詳細12項目) ≈ fixed_cost
   ```
   ※ 切り捨て誤差により完全一致しない場合がある

2. **総コストの一致**:
   ```python
   total_cost = fixed_cost + distance_cost
   ```

3. **フリート集計の一致**:
   ```python
   fleet.total_cost = Σ(route.total_cost for all routes)
   ```

### 9.3 後方互換性

- すべての新パラメータは`Optional`
- `vehicle_metadata_map`がNoneの場合：
  - 基本3項目（fixed_cost, distance_cost, total_cost）のみ生成
  - 詳細内訳は含まれない
  - 既存コードは変更なしで動作

---

## 10. システム設計の評価

### 10.1 設計の長所

1. **関心の分離**:
   - データ保持: VehicleCandidate
   - 最適化計算: VehicleType
   - 詳細表示: cost_breakdown

2. **拡張性**:
   - 新しいコスト項目の追加が容易
   - cost_breakdownは動的な辞書構造

3. **パフォーマンス**:
   - VehicleTypeは軽量で高速比較が可能
   - 詳細計算は結果生成時のみ実行

4. **後方互換性**:
   - 既存コードへの影響最小
   - Optional引数による段階的導入

### 10.2 設計の注意点

1. **データの二重管理**:
   - VehicleCandidateとVehicleTypeで同じ車両を表現
   - 同期が必要（vehicle_metadata_mapで解決）

2. **単位の混在**:
   - 変動費: 円/km
   - 固定費: 万円/年
   - 計算時の単位変換に注意

3. **切り捨て誤差**:
   - int()による切り捨てで微小誤差が累積
   - 詳細内訳の合計と基本値がずれる可能性

4. **metadataの依存**:
   - session_stateに保存されたmetadataに依存
   - セッション管理が重要

---

## 11. 実装ファイル一覧

| ファイル | 役割 | 主要な関数/クラス |
|---------|------|------------------|
| `data/processed/vehicles.json` | データソース | 25項目の詳細データ |
| `src/services/master_repository.py` | データ読み込み | `VehicleCandidate`, `load_processed_master()` |
| `src/services/vehicle_catalog.py` | 最適化用モデル | `VehicleType`, `VehicleCatalog` |
| `src/services/optimizer.py` | コスト計算・最適化 | `_evaluate_cost()`, `solve_routing()`, `solve_fleet_routing()` |
| `src/app.py` | UI・制御 | `_generate_vehicle_defaults()`, `_display_detailed_cost_breakdown()` |

---

## 12. コスト算出フローチャート

```
┌─────────────────────┐
│  vehicles.json      │
│  (25項目)           │
└──────────┬──────────┘
           │ load_processed_master()
           ↓
┌─────────────────────┐
│ VehicleCandidate    │
│ (詳細データ保持)    │
└──────────┬──────────┘
           │ _generate_vehicle_defaults()
           ↓
┌─────────────────────┐
│ VehicleType         │
│ (最適化用簡略版)    │
│ + metadata          │
│   (session_state)   │
└──────────┬──────────┘
           │ solve_routing()
           ↓
┌─────────────────────┐
│ ルート最適化        │
│ (OR-Tools/heuristic)│
└──────────┬──────────┘
           │ 総走行距離
           ↓
┌─────────────────────┐
│ _evaluate_cost()    │
│ + vehicle_metadata  │
└──────────┬──────────┘
           │
           ├─→ 基本コスト計算（3項目）
           │   - variable_cost
           │   - fixed_cost
           │   - total_cost
           │
           ├─→ 変動費詳細（13項目）
           │   - 単価 × 距離
           │
           └─→ 固定費詳細（12項目）
               - (年間費用 / 年間距離) × 距離
           ↓
┌─────────────────────┐
│ cost_breakdown      │
│ (29項目の辞書)      │
└──────────┬──────────┘
           │ Solution/FleetSolution
           ↓
┌─────────────────────┐
│ UI表示              │
│ - 基本テーブル      │
│ - 詳細内訳          │
└─────────────────────┘
```

---

## 13. まとめ

### 13.1 総コスト算出の核心

総コストは以下の2段階で算出されます：

1. **最適化フェーズ**:
   - VehicleTypeの軽量モデルで高速比較
   - `per_km_cost`と`fixed_cost_per_km`で概算評価

2. **詳細計算フェーズ**:
   - VehicleCandidateの詳細データで精密計算
   - 25項目の内訳を生成

### 13.2 システムの特徴

- **分離された責務**: 最適化と詳細計算を分離
- **完全な透明性**: すべての計算過程が可視化
- **拡張可能な設計**: 新コスト項目の追加が容易
- **後方互換性**: 既存システムへの影響最小

### 13.3 データフローの要点

```
データ保持: VehicleCandidate (完全)
    ↓
最適化計算: VehicleType (簡略)
    ↓
結果生成: cost_breakdown (復元・拡張)
```

このアーキテクチャにより、**高速な最適化**と**詳細な透明性**の両立を実現しています。

---

**ドキュメント終了**
