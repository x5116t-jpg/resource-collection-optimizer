# 資源回収ルート最適化システム - 使い方マニュアル

**バージョン**: 1.0
**最終更新**: 2025年11月28日

---

## 📋 目次

1. [システム概要](#システム概要)
2. [起動方法](#起動方法)
3. [画面構成](#画面構成)
4. [基本的な使い方](#基本的な使い方)
5. [詳細な操作手順](#詳細な操作手順)
6. [機能詳細](#機能詳細)
7. [結果の見方](#結果の見方)
8. [トラブルシューティング](#トラブルシューティング)
9. [よくある質問](#よくある質問)

---

## システム概要

### このシステムでできること

資源回収ルート最適化システムは、以下のことができます：

✅ **地図上で回収ルートを計画**
- 地図をクリックするだけで簡単に地点を選択
- 車庫、回収地点、集積場所を視覚的に設定

✅ **コストを最小化**
- 複数の車種から最適なものを自動選択
- 固定費・変動費を詳細に計算
- 総コストが最も安いルートを提案

✅ **環境に配慮**
- エネルギー消費量（kWh）を計算
- EV（電気自動車）のCO2削減効果を表示

✅ **視覚的に確認**
- 地図上でルートを確認
- 訪問順序を番号付きで表示
- 詳細なコスト内訳をテーブル表示

---

## 起動方法

### 必要な環境

- **Python**: 3.8以上
- **必要なライブラリ**: requirements.txt参照
- **データファイル**:
  - 道路ネットワークデータ（data/road_network_*.json）
  - マスタデータ（data/processed/）

### 起動手順

#### Windows

1. **コマンドプロンプトまたはPowerShellを開く**

2. **プロジェクトフォルダに移動**
   ```cmd
   cd D:\py\Resource Collection\ResouceCollection_05
   ```

3. **仮想環境をアクティブ化（既に設定済みの場合）**
   ```cmd
   .venv\Scripts\activate
   ```

4. **Streamlitアプリを起動**
   ```cmd
   streamlit run src/app.py
   ```

5. **ブラウザで自動的に開く**
   - 通常は http://localhost:8501 で開きます
   - 自動で開かない場合は、上記URLをブラウザに入力

#### バッチファイルで起動（より簡単）

プロジェクトルートにある `run_app.bat` をダブルクリックするだけで起動できます。

```
run_app.bat
```

### 終了方法

- **ブラウザのタブを閉じる**: アプリの表示が終了
- **サーバーを停止**: コマンドプロンプトで `Ctrl + C` を押す

---

## 画面構成

システムの画面は大きく3つのエリアに分かれています：

```
┌─────────────────────────────────────────────────────┐
│  [サイドバー]              [メインエリア]            │
│  ┌──────────┐            ┌────────────────────┐   │
│  │ファイル選択│            │ 📍 地点選択          │   │
│  │          │            │ ・地図表示           │   │
│  │ノード数   │            │ ・地点リスト         │   │
│  │エッジ数   │            ├────────────────────┤   │
│  │          │            │ ⚡ 最適化実行        │   │
│  │選択状況   │            │ ・実行前チェック     │   │
│  │ ✅車庫    │            │ ・実行ボタン         │   │
│  │ ✅回収    │            ├────────────────────┤   │
│  │ ✅集積    │            │ 📊 結果表示          │   │
│  │ ✅車種    │            │ ・ルート地図         │   │
│  └──────────┘            │ ・コスト詳細         │   │
│                          │ ・エネルギー消費     │   │
│                          └────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

### サイドバー（左側）

- **道路ネットワークファイル選択**: 使用する地図データを選択
- **ノード数・エッジ数**: 選択したネットワークの規模
- **現在の選択状況**: 設定済みの地点と車種の確認
  - ✅: 設定済み
  - ⚠️: 未設定

### メインエリア（右側）

#### セクション1: 地点選択
- 地図表示エリア
- クリックモード選択（車庫/回収地点/集積場所）
- 選択済み回収地点のリスト

#### セクション2: 最適化実行
- 実行前チェックリスト
- 最適化実行ボタン

#### セクション3: 結果表示（実行後）
- 最適ルートの地図表示
- コスト詳細表
- エネルギー消費量

---

## 基本的な使い方

### クイックスタート（5ステップ）

#### 📍 ステップ1: 道路ネットワークを選択

サイドバーから使用する道路ネットワークファイルを選択します。

```
[サイドバー]
道路ネットワークファイル
▼ road_network_20251017_154630.json  ← 選択
```

#### 🏠 ステップ2: 車庫を設定

1. **地図クリックモード**で「車庫」を選択
2. **地図上**の車庫にしたい地点をクリック
3. 最寄りのノードが車庫に設定されます

```
地図クリックモード: ○ 車庫  ○ 回収地点  ○ 集積場所
                    👆
```

**ヒント**:
- 🟢 緑色のマーカーが車庫を表します
- 地図はズーム・ドラッグで移動できます

#### 📦 ステップ3: 回収地点を設定

1. **地図クリックモード**で「回収地点」を選択
2. **地図上**の回収地点をクリック
3. **ダイアログ**が表示されるので入力：
   - 資源種別（紙、プラスチック等）を選択
   - 回収量（kg）を入力
   - 「追加」ボタンをクリック
4. 必要な回収地点をすべて追加

```
┌─────────────────────────┐
│  回収地点の追加          │
├─────────────────────────┤
│  ノード: 123456789      │
│                         │
│  回収量 (kg)            │
│  [  100  ] ▲▼          │
│                         │
│  資源種別               │
│  [紙        ▼]         │
│                         │
│  [追加]  [キャンセル]   │
└─────────────────────────┘
```

**ヒント**:
- 🔵 青色のマーカーが回収地点を表します
- 複数地点を追加できます
- 後から編集・削除も可能

#### 🏭 ステップ4: 集積場所を設定

1. **地図クリックモード**で「集積場所」を選択
2. **地図上**の集積場所をクリック
3. 最寄りのノードが集積場所に設定されます

**ヒント**:
- 🔴 赤色のマーカーが集積場所を表します
- 車庫とは異なる地点を選択してください

#### ⚡ ステップ5: 最適化を実行

1. **実行前チェック**で全項目が✅になっていることを確認
2. **「最適化を実行」ボタン**をクリック
3. 計算中のプログレスバーが表示されます
4. 完了すると結果が表示されます

```
✅ 実行前チェック
✅ 車庫が設定されている
✅ 集積場所が設定されている
✅ 車庫と集積場所が異なる
✅ 回収地点が1箇所以上ある
✅ 全回収地点に資源種別が設定されている
✅ 車種が1種類以上設定されている
✅ 車種割当プランが作成されている
✅ 車種割当に警告がない

🎉 すべての条件を満たしています。最適化を実行できます。

[最適化を実行]  ← クリック
```

---

## 詳細な操作手順

### 🗺️ 地図操作

#### 地図の基本操作

| 操作 | 方法 |
|------|------|
| **ズームイン** | マウスホイールを上にスクロール |
| **ズームアウト** | マウスホイールを下にスクロール |
| **地図を移動** | ドラッグ＆ドロップ |
| **地点を選択** | 地図上をクリック |

#### 地点の色分け

| 色 | 意味 |
|---|------|
| 🟢 **緑** | 車庫（出発・帰着地点） |
| 🔵 **青** | 回収地点 |
| 🔴 **赤** | 集積場所（終点） |
| 🟡 **黄枠** | 最新の選択・更新地点 |

#### クリックモードの切り替え

地図上でクリックした時の動作を、ラジオボタンで切り替えます：

```
地図クリックモード:
○ 車庫     ← 選択すると、次のクリックで車庫を設定
○ 回収地点  ← 選択すると、次のクリックで回収地点を追加
○ 集積場所  ← 選択すると、次のクリックで集積場所を設定
```

---

### 📦 回収地点の管理

#### 回収地点の追加

1. クリックモードを「回収地点」に設定
2. 地図上をクリック
3. ダイアログで情報を入力：
   - **回収量**: 0〜100,000 kg（50kg刻み）
   - **資源種別**: プルダウンから選択
4. 「追加」ボタンをクリック

#### 回収地点の編集

既に追加した回収地点は、リストから編集できます：

```
📦 選択済み回収地点

▼ #1 123456789 - 紙 100kg
   資源種別: [紙        ▼]
   回収量(kg): [  100  ] ▲▼
   [更新]  [🗑️]

▼ #2 987654321 - プラスチック 150kg
   資源種別: [プラスチック▼]
   回収量(kg): [  150  ] ▲▼
   [更新]  [🗑️]
```

**操作**:
- **展開/折りたたみ**: 地点番号をクリック
- **編集**: 値を変更して「更新」ボタンをクリック
- **削除**: 🗑️ボタンをクリック

#### 回収地点の一括削除

すべての回収地点を削除する場合：

```
[🗑️ すべての回収地点をクリア]
```

**注意**: この操作は元に戻せません。

---

### 🚗 車種の設定

車種情報は自動的にマスタデータから読み込まれますが、手動で編集も可能です。

#### 車種テーブルの表示

```
車種候補

┌──────┬────────┬──────────┬────────────┐
│ 名称  │容量[kg]│ 固定費[円]│距離単価[円/km]│
├──────┼────────┼──────────┼────────────┤
│ 小型EV│  500   │   0      │   120      │
│ 大型  │ 1500   │   0      │    90      │
└──────┴────────┴──────────┴────────────┘
```

#### 車種の編集

1. **セルをクリック**して値を編集
2. **Enter**で確定
3. **+/-ボタン**で行を追加・削除

#### 車種の検証

入力後、自動的に検証が行われます：

```
✅ 車種設定に問題はありません
```

エラーがある場合：

```
❌ 小型EV: 容量は1以上を設定してください
⚠️ 大型: 重複した車種名があります
```

#### マスタデータから再読込

編集内容を破棄して、マスタデータから再読み込みする場合：

```
[マスタから再読込]
```

---

### 🎯 車種割当の確認

システムは、各資源種別に対して最適な車種を自動的に割り当てます。

#### 適合性の表示

回収地点の資源種別を選択すると、その資源に対応できる車種が表示されます：

```
#1 123456789 - 紙 100kg

資源種別: [紙  ▼]
制約: なし / 嵩密度: 0.15t/m³

適合車種: 小型EV, 大型
非適合車種: （なし）
```

#### 警告の確認

資源に対応できる車種がない場合、警告が表示されます：

```
⚠️ 車種割当の警告

⚠️ 資源 'プラスチック' に対応できる車種が見つかりません。

💡 警告を解消してから最適化を実行することを推奨します。
```

**対処法**:
- 車種設定を確認
- マスタデータの適合性設定を確認
- 資源種別を変更

---

### ⚡ 最適化実行

#### 実行前チェックリスト

最適化を実行する前に、以下の条件を満たす必要があります：

| チェック項目 | 説明 |
|------------|------|
| ✅ 車庫が設定されている | 地図上で車庫を選択済み |
| ✅ 集積場所が設定されている | 地図上で集積場所を選択済み |
| ✅ 車庫と集積場所が異なる | 同じ地点は不可 |
| ✅ 回収地点が1箇所以上ある | 最低1箇所必要 |
| ✅ 全回収地点に資源種別が設定されている | 資源種別と回収量が必須 |
| ✅ 車種が1種類以上設定されている | 最低1種類必要 |
| ✅ 車種割当プランが作成されている | 自動生成される |
| ✅ 車種割当に警告がない | 警告がある場合は要対処 |

#### 実行ボタン

すべての条件を満たすと、ボタンが有効になります：

```
[最適化を実行]  ← クリック可能
```

条件を満たしていない場合：

```
[最適化を実行]  ← グレーアウト（クリック不可）
```

#### 実行中の表示

実行中は、プログレスバーと状態メッセージが表示されます：

```
📊 距離行列を計算中...
[████████████████        ] 50%

🚗 車種割当を準備中...
[████████████████████████] 75%

⚡ 最適化を実行中...
[████████████████████████] 100%

✅ 完了しました！
```

**所要時間の目安**:
- 地点数 5箇所: 約5秒
- 地点数 10箇所: 約10秒
- 地点数 20箇所: 約30秒

---

## 機能詳細

### 📍 地点選択機能

#### 最寄りノード検索

地図をクリックすると、クリック位置から最も近いノード（道路上の地点）が自動的に選択されます。

**仕組み**:
1. クリック位置の緯度・経度を取得
2. 空間インデックスで高速検索
3. 最寄りのノードを特定
4. そのノードを選択地点として設定

#### 地点の重複チェック

システムは以下の重複を自動的にチェックします：

- 車庫と集積場所が同じ → ❌ エラー
- 車庫と回収地点が同じ → ⚠️ 警告（追加不可）
- 集積場所と回収地点が同じ → ⚠️ 警告（追加不可）
- 既存の回収地点と同じ → ℹ️ 情報（既に追加済み）

---

### 🚗 車種選択機能

#### 自動車種割当

システムは以下のロジックで最適な車種を自動選択します：

**ケース1: 単一車種で対応可能**
- すべての資源種別を1台の車種で運べる場合
- その車種を選択（コストが最も安い車種）

**ケース2: 複数車種が必要**
- 資源種別ごとに対応可能な車種を抽出
- 各資源に対して最もコスト効率の良い車種を選択

**コスト評価式**:
```
コストスコア = 距離単価 + 固定費単価
```

#### 車種適合性マトリクス

マスタデータに基づき、どの車種がどの資源を運べるか判定します：

```
         │ 紙 │プラスチック│ガラス│
─────────┼────┼──────────┼──────┤
小型EV   │ ○ │    ○     │  ×  │
大型     │ ○ │    ○     │  ○  │
専用車   │ × │    ×     │  ○  │
```

○: 対応可能
×: 対応不可
空欄: データなし（対応可と見なす）

---

### ⚡ ルート最適化機能

#### 最適化アルゴリズム

**問題**: VRP（Vehicle Routing Problem）の変種

**目的関数**:
```
最小化: 総コスト = 固定費 + 変動費
```

**制約条件**:
1. 各回収地点を必ず1回訪問
2. 車両容量を超えない
3. 車庫から出発し、集積場所で終了
4. 資源と車種の適合性を満たす

**アルゴリズム**:
1. **初期解生成**: 近傍優先の貪欲法
   - 現在地から最も近い未訪問地点を選択
   - 容量制約をチェック
2. **局所最適化**: 2-opt法による改善
   - ルートの一部を入れ替えて改善を試行
   - 改善がなくなるまで繰り返し

**計算量**: O(N² × M)
- N: 地点数
- M: 車種数

---

### 💰 コスト計算機能

#### 固定費の計算

固定費は、年間固定費をkm単価に換算して計算します：

```
固定費 = Σ (年間固定費項目i ÷ 年間走行距離 × 実走行距離)
```

**固定費項目の例**:
- 人件費
- 車両償却費
- 保険料
- 車検・点検費用

#### 変動費の計算

変動費は、距離単価を元に計算します：

```
変動費 = Σ (変動費項目j の単価 × 実走行距離)
```

**変動費項目の例**:
- 燃料費（または電気代）
- タイヤ代
- 修繕費
- 消耗品費

#### 総コストの計算

```
総コスト = 固定費合計 + 変動費合計
```

#### エネルギー消費量の計算

EV（電気自動車）の場合：

```
消費電力量[kWh] = 消費原単位[kWh/km] × 実走行距離[km]
```

**CO2削減効果の計算**:
```
CO2削減量[kg] = ガソリン車のCO2排出量 - EV車のCO2排出量
```

---

## 結果の見方

### 📊 結果表示エリア

最適化が完了すると、以下の情報が表示されます：

#### 1. サマリー情報

```
✅ 最適化が完了しました。

総距離 [km]              18.5 km
総コスト [円]            2,220円
エネルギー消費量 [kWh]    3.7 kWh

採用車種: 小型EV
ルート順: 車庫 → 回収A → 回収B → 回収C → 集積場所
```

#### 2. コスト内訳テーブル

```
┌──────┬─────────┐
│ 項目  │ 金額     │
├──────┼─────────┤
│ 固定費│  1,110円 │
│ 距離費│  1,110円 │
│ 総額  │  2,220円 │
└──────┴─────────┘
```

#### 3. 詳細コスト内訳

##### 変動費詳細

```
車両: 小型EV | 走行距離: 18.5 km

┌────────────┬──────────┬────────┬──────────┐
│ 費用項目    │単価(円/km)│距離(km) │金額(円)  │
├────────────┼──────────┼────────┼──────────┤
│ 燃料費      │   80.00  │  18.5  │  1,480   │
│ タイヤ代    │   20.00  │  18.5  │    370   │
│ 修繕費      │   15.00  │  18.5  │    278   │
└────────────┴──────────┴────────┴──────────┘

変動費合計: 2,128円
```

##### 固定費詳細

```
車両: 小型EV | 走行距離: 18.5 km

┌────────────┬──────────┬────────┬──────────┐
│ 費用項目    │km単価(円)│距離(km) │金額(円)  │
├────────────┼──────────┼────────┼──────────┤
│ 人件費      │   30.00  │  18.5  │    555   │
│ 車両償却費   │   25.00  │  18.5  │    463   │
│ 保険料      │   10.00  │  18.5  │    185   │
└────────────┴──────────┴────────┴──────────┘

固定費合計: 1,203円
```

##### 計算式の表示

数式で計算方法を確認できます：

```
📐 コスト計算式

総コスト = 変動費 + 固定費

変動費の計算:
変動費 = Σ (単価i × 走行距離)

固定費の計算:
固定費 = Σ (年間費用i / 年間走行距離 × 走行距離)

💵 計算結果
変動費: 2,128円
固定費: 1,203円
総コスト: 3,331円
```

#### 4. 地図表示

最適化されたルートが地図上に表示されます：

**マーカー**:
- 番号付き円形マーカー
- 色分け:
  - 🟢 1番目（出発地）
  - 🔵 2〜N-1番目（経由地）
  - 🔴 最終番号（終点）

**経路**:
- 青い線で結ばれています
- 実際の道路に沿った経路

**操作**:
- ズーム: マウスホイール
- パン: ドラッグ
- マーカークリック: 地点情報を表示

---

### 🚛 複数車両の結果

複数の車種を使用する場合の表示：

```
✅ 複数車両で最適化が完了しました。

総距離 [km]              32.8 km
総コスト [円]            4,560円
総エネルギー消費量 [kWh]  6.2 kWh

┌──────┬─────────┐
│ 項目  │ 金額     │
├──────┼─────────┤
│ 固定費│  2,280円 │
│ 距離費│  2,280円 │
│ 総額  │  4,560円 │
└──────┴─────────┘

─────────────────────────────────────

車両 1: 小型EV
対応資源: 紙
対象ノード: 回収A, 回収B

総距離 [km]      15.3 km
総コスト [円]    1,836円

ルート順: 車庫 → 回収A → 回収B → 集積場所

[地図表示]

─────────────────────────────────────

車両 2: 大型
対応資源: プラスチック
対象ノード: 回収C

総距離 [km]      17.5 km
総コスト [円]    2,724円

ルート順: 車庫 → 回収C → 集積場所

[地図表示]
```

---

## トラブルシューティング

### 🔧 よくあるエラーと対処法

#### エラー: 「解が見つかりません」

**原因**:
- 車両容量が不足
- 資源と車種の不適合
- データの不整合

**対処法**:
1. 回収量を減らす
2. 容量の大きい車種を追加
3. 資源種別の適合性を確認
4. 回収地点を分割して複数回に分ける

#### エラー: 「車庫と集積場所は異なるノードを選択してください」

**原因**: 車庫と集積場所が同じ地点

**対処法**: 集積場所を別の地点に変更

#### 警告: 「資源 'プラスチック' に対応できる車種が見つかりません」

**原因**: 選択した資源種別に対応する車種がない

**対処法**:
1. 資源種別を変更
2. 対応車種を追加
3. マスタデータの適合性設定を確認

#### 地図が表示されない

**原因**:
- foliumライブラリの問題
- ブラウザの互換性

**対処法**:
1. ブラウザを再読み込み（F5）
2. 別のブラウザで試す（Chrome推奨）
3. foliumとstreamlit-foliumを再インストール:
   ```bash
   pip install --upgrade folium streamlit-folium
   ```

#### 回収地点のダイアログが表示されない

**原因**: Streamlitのバージョンの問題

**対処法**:
1. ページを再読み込み
2. もう一度地点をクリック
3. Streamlitを最新版に更新:
   ```bash
   pip install --upgrade streamlit
   ```

#### 処理が遅い

**原因**:
- 地点数が多い
- ネットワークが大きい

**対処法**:
1. 地点数を減らす（20地点以内を推奨）
2. 回収地点を近い地点にまとめる
3. より小さい範囲の道路ネットワークを使用

---

## よくある質問

### Q1. 何地点まで設定できますか？

**A**: 技術的には制限はありませんが、以下を推奨します：

- **推奨**: 10〜20地点
- **最大**: 50地点程度
- **処理時間**:
  - 10地点: 約10秒
  - 20地点: 約30秒
  - 50地点: 数分

### Q2. 複数日のスケジュールを作成できますか？

**A**: 現在のバージョンでは、単一日のルートのみ対応しています。
複数日のスケジュールが必要な場合は、各日ごとに別々に実行してください。

### Q3. 時間帯指定はできますか？

**A**: 現在のバージョンでは、時間帯指定には対応していません。
距離ベースの最適化のみです。

### Q4. 道路ネットワークを追加できますか？

**A**: 可能です。OSM（OpenStreetMap）データから道路ネットワークJSONを生成するスクリプトを使用してください。

詳細は `scripts/` ディレクトリのドキュメントを参照してください。

### Q5. 車種や資源種別を追加できますか？

**A**: 可能です。`data/processed/` ディレクトリのマスタデータを編集してください：

- `vehicles.json`: 車種情報
- `resources.json`: 資源種別情報
- `compatibility.json`: 適合性情報

詳細は各ファイルのフォーマットを参照してください。

### Q6. 結果をエクスポートできますか？

**A**: ブラウザの機能を使用してください：

- **PDFで保存**: `Ctrl + P` → PDFに保存
- **スクリーンショット**: `Windows + Shift + S`
- **地図のスクリーンショット**: 地図エリアを右クリック → 画像を保存

### Q7. 結果を他の人と共有できますか？

**A**: 以下の方法があります：

1. **PDFで共有**: ブラウザから印刷 → PDF保存
2. **スクリーンショット**: 結果画面をキャプチャ
3. **URL共有**: 同じネットワーク内であればURL共有可能

### Q8. セッション情報は保存されますか？

**A**: はい、以下の情報はブラウザのセッションに保存されます：

- 選択した地点
- 車種設定
- 最適化結果

ただし、ブラウザを閉じると消去されます。

### Q9. オフラインで使用できますか？

**A**: 部分的に可能です：

- **地図表示**: インターネット接続が必要（Foliumがオンラインタイルを使用）
- **最適化計算**: オフラインで可能

完全オフラインで使用する場合は、オフライン地図タイルの設定が必要です。

### Q10. エラーが出た場合、どうすればいいですか？

**A**: 以下の順で確認してください：

1. エラーメッセージを確認
2. このマニュアルの[トラブルシューティング](#トラブルシューティング)を参照
3. ブラウザを再読み込み（F5）
4. アプリを再起動
5. 上記で解決しない場合は、システム管理者に連絡

---

## 📞 サポート情報

### お問い合わせ

システムに関する質問や不具合の報告は、プロジェクト管理者までお問い合わせください。

### バグ報告時の情報

以下の情報を含めてご連絡ください：

1. **エラーメッセージ**: 表示されたエラー内容
2. **操作手順**: エラーが発生するまでの操作
3. **データ**: 使用した道路ネットワークファイル名
4. **環境**: Pythonバージョン、OSバージョン

---

## 📚 関連ドキュメント

- **システムフロー図**: `system_flowchart.svg`
- **技術詳細説明**: `system_flowchart_explanation.md`
- **設計書**: `docs/design.md`
- **コスト計算詳細**: `claudedocs/20251023_総コスト算出システム全体分析.md`

---

**最終更新**: 2025年11月28日
**バージョン**: 1.0
**対象システム**: 資源回収ルート最適化システム
