# マスタデータ統合設計

## 1. 背景と課題
- 車庫・回収・集積動線の最適化システムでは、資源種別や車両情報を手入力で管理しており、データの整合性や根拠表示が難しい。
- CSV 形式で提供されたマスタ (`車両資源適合性マトリックス.csv`, `車両諸元表.csv`, `未利用資源特性表.csv`, `補足データ集.csv`) を直接参照する仕組みがなく、UI とサービス層が手動データに依存している。
- CSV 内には BOM や範囲表記、説明行などのノイズが存在し、そのままではプログラムの入力として利用できない。

## 2. 目標
- マスタ CSV を定型的にクレンジングし、Streamlit アプリから再利用できる共通ローダーを実装する。
- ピックアップ資源の選択 UI をマスタ参照型に置き換え、資源特性の参照・自動入力を可能にする。
- 車両マスタから候補車種とコストを自動計算し、車両-資源適合性マトリクスを利用したフィルタリングを実現する。
- 補足データをコスト算出ロジックに組み込み、算出根拠をユーザーに提示できるようにする。

## 3. データクレンジング方針
### 3.1 共通処理
- CSV 読み込みには UTF-8 (BOM あり) を想定し、先頭列に混入した `\ufeff` を除去。
- 空欄・"-" は `None` に変換。
- 範囲表記 (例: `10-20`, `1.2-3.4`) は `{"min": float, "max": float, "avg": (min+max)/2}` に整形。
- 数値に単位が含まれる場合 (`150円/L`, `30%割引`) は数値部分と単位を分離するヘルパーを定義。

### 3.2 ファイル別処理
- **車両資源適合性マトリックス**: `1`/`0`/`-` を `True`/`False`/`None` に変換。条件付き列は文字列のまま保持。
- **車両諸元表**: 主要カラム (容量、最大積載量、燃費、燃料タイプ、固定費関連) を正規化。年間コスト項目は円換算し、`年間走行距離_km` を基準に固定費/kmを計算する準備を行う。
- **未利用資源特性表**: 嵩密度の min/max/avg を算出し、制約タイプ等のカテゴリは Enum/定数化を検討。
- **補足データ集**: `データ種別` でグルーピングし、利用するカテゴリ (燃費補正係数、燃料単価、NEXCO料金区分 等) を辞書化。説明行 (`注記`, 数字付き注意書き) は別セクションに蓄積。

## 4. 共通データローダー設計
- 新モジュール `src/infra/data_loader.py` (仮称) を追加。
    - クラス `MasterData` に、車両諸元・資源特性・適合マトリクス・補足データを読み込む責務を持たせる。
    - `@st.cache_resource` または `@st.cache_data` を用いて読み込み結果をキャッシュ。
    - 読み込み失敗時は `st.error` とログ出力。
- ヘルパー
    - `parse_range(value: str) -> Optional[RangeValues]`
    - `parse_price(value: str) -> Optional[PriceValue]`
    - `clean_dict_row(row: Dict[str, str]) -> Dict[str, Optional[str]]`
    - `load_csv(path: Path) -> Tuple[List[str], List[Dict[str, str]]]`
- 返却構造
    - `MasterData.vehicles`: Dict[str, VehicleSpec]
    - `MasterData.resource_traits`: Dict[str, ResourceTrait]
    - `MasterData.compatibility`: Dict[str, CompatibilityInfo]
    - `MasterData.supplement`: Dict[str, List[SupplementEntry]]

## 5. 資源セレクター刷新
- `_collect_pickup_inputs` を分割し、資源選択 UI を `selectbox` + `st.data_editor` ベースに再構築。
    1. `MasterData.resource_traits` から `資源名` を取得し、ドロップダウンを生成。
    2. 選択時に嵩密度平均値や制約タイプを表示し、デフォルト量 (kg) を推奨値 (例: 嵩密度avg × 想定容積) で自動入力。
    3. ゲート料レンジ・処理方法をサマリとして表示。
    4. `pickup_attrs` には `resource_id` をキーとした構造 `{qty_kg, resource_type, notes}` を保持。
- 既存のフリーテキスト入力は補助として残すか、備考欄に移行。
- 資源種別の絞り込み (例: 車両適合性マトリクスを参照して現在の車種候補で運べる資源のみ表示) は後段の車両連動で実現。

## 6. 車両マスタ自動反映
### 6.1 VehicleCatalog 初期化
- `_init_session_state` での初期値を廃止し、`MasterData.vehicles` からのロードに置き換え。
- `VehicleSpec` から `capacity_kg`, `fixed_cost_per_km`, `per_km_cost` を計算し、`VehicleCatalog.add_vehicle` へ投入。
    - `capacity_kg`: `最大積載量_t` × 1000 (平均値を利用)
    - `per_km_cost`: 燃料費 + タイヤ/修理/高速/作業人件費など可変要素の平均値を合算。
    - `fixed_cost`: 年間固定費計 (購入費減価償却 + 税 + 保険 + 車庫賃料等) ÷ `年間走行距離_km` + 補足データの感度設定を適用。
- UI 側では、車両行を編集可能に保ちつつ「マスタから再ロード」ボタンを追加し、CSV の更新反映を容易にする。

### 6.2 適合性フィルタ
- `車両資源適合性マトリクス` を `Dict[vehicle_type, CompatibilitySet]` に変換。
- ピックアップ資源選択時に `現在選択している車種` (Catalog 内の vehicle) と照合し、適合しない車両を警告表示。
- もしくは「資源→利用可能車種」マップを事前に計算し、車両候補テーブルに適合資源をラベル表示。

### 6.3 補足データ活用
- `補足データ集` の燃費補正係数は UI で走行環境 (高速中心/市街地/山間部) を選択させ、`per_km_cost` の再計算に反映。
- 燃料単価は直近月次を採用し、燃費 (km/L) から燃料費円/kmを再算出。
- 高速料金区分や ETC 割引は `per_km_cost` 計算に乗算係数として組み込む。
- 補助員や人件費は備考・フラグ (`備考` に「重量物は2名体制」など) を解析し、補助員コストを自動付加する拡張も検討。

## 7. 実装ステップ
1. **データローダー導入**
    - クレンジングヘルパーを実装し、4ファイルの読み込みロジックを作成。
    - 単体テスト (pytest) を追加し、範囲値変換や必須列チェックを検証。
2. **UI へのマスタ参照導入**
    - 資源セレクターを新設し、既存 `_collect_pickup_inputs` を置換。
    - 旧 `pickup_attrs` から新構造への移行処理を実装（互換性のため旧キーが存在する場合の変換）。
3. **車両カタログの自動生成**
    - VehicleCatalog 初期化をローダー経由に変更。
    - per-km コスト計算関数を追加し、補足データを組み込む。
    - UI で「マスタ再読込」「車両適合性メモ」などの情報表示を追加。
4. **適合性チェックの連携**
    - 資源選択時の車両適合チェック、車両編集時の資源候補フィルタリングを実装。
5. **動作確認・調整**
    - Streamlit 上でデータ更新 → リロード → 反映までのフローを検証。
    - マスタ CSV が更新・追加された場合のエラーハンドリングを確認。

## 8. テスト観点
- 各 CSV をロードした際に BOM/範囲/欠損が正しく処理されるか。
- 資源選択 UI でマスタに存在しない資源が選べないことを確認。
- 車両カタログ読込後、固定費・距離単価の算出結果が想定範囲内か (サンプル計算値と比較)。
- 補足データの設定値を変更した際に per-km コストが再計算されるか。
- 無効な CSV (列欠損) を与えた場合に適切なエラーメッセージが表示されるか。

## 9. 今後の拡張余地
- マスタデータを SQLite などへ移行し、更新履歴やバージョン管理を行う。
- CSV 編集用の管理 UI を別途用意し、運用担当から直接更新できる仕組みを整備。
- コスト算出ロジックをより高度化 (例: 走行パターン別シナリオ、季節変動、補助員シフト管理) し、補足データ集の注記を自動反映。

