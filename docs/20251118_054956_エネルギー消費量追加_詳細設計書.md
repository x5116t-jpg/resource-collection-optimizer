# エネルギー消費量追加機能 詳細設計書

**作成日**: 2025年11月18日
**バージョン**: 1.0
**対象システム**: 資源回収ルート最適化ツール

---

## 目次

1. [概要](#1-概要)
2. [背景と要求事項](#2-背景と要求事項)
3. [エネルギー変換の理論的背景](#3-エネルギー変換の理論的背景)
4. [システムアーキテクチャ](#4-システムアーキテクチャ)
5. [データモデル設計](#5-データモデル設計)
6. [計算ロジック設計](#6-計算ロジック設計)
7. [UI/UX設計](#7-uiux設計)
8. [データ準備](#8-データ準備)
9. [実装手順](#9-実装手順)
10. [テスト計画](#10-テスト計画)
11. [運用とメンテナンス](#11-運用とメンテナンス)
12. [将来の拡張性](#12-将来の拡張性)
13. [参考資料](#13-参考資料)

---

## 1. 概要

### 1.1 目的

資源回収ルート最適化ツールに、**運行時のエネルギー消費量（kWh単位）** を追加することで、以下を実現する：

- 環境負荷の可視化
- ガソリン車・ディーゼル車・電気自動車の横断的比較
- CO2排出量計算への拡張基盤構築
- 持続可能な配送計画の支援

### 1.2 適用範囲

本設計書は以下のコンポーネントに適用される：

- データモデル: `VehicleCandidate`, `VehicleType`
- 計算エンジン: `optimizer.py`
- ユーザーインターフェース: `app.py`
- マスターデータ: `data/processed/vehicles.json`

### 1.3 主要な設計方針

| 項目 | 方針 |
|------|------|
| **単位統一** | すべてのエネルギー消費量をkWh（キロワット時）に統一 |
| **既存データ活用** | 既存の`fuel_efficiency_km_per_l`（燃費データ）を活用 |
| **後方互換性** | 既存機能に影響を与えない設計 |
| **拡張性** | 電気自動車（EV）への対応を考慮 |
| **正確性** | 燃料エネルギー密度は国際標準値を使用 |

---

## 2. 背景と要求事項

### 2.1 背景

現在、システムは以下の出力を提供している：

- 総走行距離（km）
- 総コスト（円）: 固定費 + 変動費
- ルート順序
- 詳細なコスト内訳

しかし、**環境負荷**（エネルギー消費量、CO2排出量など）の情報が欠けている。

### 2.2 要求事項

#### 機能要求

| ID | 要求内容 | 優先度 |
|----|---------|-------|
| FR-01 | 運行ごとのエネルギー消費量をkWh単位で表示 | 高 |
| FR-02 | フリート全体のエネルギー消費量を集計表示 | 高 |
| FR-03 | ガソリン車・ディーゼル車・EVを統一単位で比較可能 | 高 |
| FR-04 | 既存の燃費データから自動計算 | 中 |
| FR-05 | 将来的なCO2排出量計算への拡張基盤 | 低 |

#### 非機能要求

| ID | 要求内容 | 基準 |
|----|---------|------|
| NFR-01 | 計算精度 | 誤差 ±5%以内 |
| NFR-02 | 後方互換性 | 既存データで動作可能 |
| NFR-03 | パフォーマンス | 計算時間への影響 < 100ms |
| NFR-04 | 保守性 | コード変更箇所を最小化 |

---

## 3. エネルギー変換の理論的背景

### 3.1 燃料エネルギー密度

燃料のエネルギー含有量は、**低位発熱量（LHV: Lower Heating Value）** で定義される。

#### 標準値（国際標準）

| 燃料タイプ | エネルギー密度 | 単位 | 参照規格 |
|----------|--------------|------|---------|
| **ガソリン** | **8.8** | kWh/L | IEA統計 |
| **軽油（ディーゼル）** | **10.0** | kWh/L | IEA統計 |
| **電気** | **1.0** | kWh/kWh | 定義値 |

**出典**: 国際エネルギー機関（IEA）, 日本エネルギー経済研究所

### 3.2 計算式

#### ガソリン車・ディーゼル車の場合

```
エネルギー消費量（kWh/km） = 燃料消費量（L/km） × エネルギー密度（kWh/L）

ここで、
燃料消費量（L/km） = 1 / 燃費（km/L）
```

**計算例: 軽トラック（ガソリン、14.5 km/L）**
```
燃料消費量 = 1 / 14.5 = 0.069 L/km
エネルギー消費量 = 0.069 × 8.8 = 0.607 kWh/km
```

**計算例: 2t平ボディ（軽油、8.5 km/L）**
```
燃料消費量 = 1 / 8.5 = 0.118 L/km
エネルギー消費量 = 0.118 × 10.0 = 1.176 kWh/km
```

#### 電気自動車（EV）の場合

```
エネルギー消費量（kWh/km） = 直接指定値（例: 0.15 kWh/km）
```

### 3.3 運行全体のエネルギー消費量

```
総エネルギー消費量（kWh） = エネルギー消費量（kWh/km） × 走行距離（km）
```

---

## 4. システムアーキテクチャ

### 4.1 データフロー

```
┌─────────────────────────────────────────────────────────────┐
│ データ層: vehicles.json                                      │
│ - fuel_efficiency_km_per_l (既存)                           │
│ - fuel_type (既存)                                          │
│ - energy_consumption_kwh_per_km (新規追加)                  │
└────────────────┬────────────────────────────────────────────┘
                 │ 読み込み
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ モデル層: VehicleCandidate                                   │
│ - エネルギー消費量の自動計算ロジック                          │
│ - fuel_efficiency → energy_consumption_kwh_per_km           │
└────────────────┬────────────────────────────────────────────┘
                 │ 変換
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ カタログ層: VehicleType                                      │
│ - energy_consumption_kwh_per_km フィールド                   │
│ - energy_consumption_kwh(distance_m) メソッド               │
└────────────────┬────────────────────────────────────────────┘
                 │ 使用
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ 計算層: optimizer.py                                         │
│ - _evaluate_cost() でエネルギー消費量を計算                  │
│ - cost_breakdown["energy_consumption_kwh"] に追加           │
└────────────────┬────────────────────────────────────────────┘
                 │ 結果
                 ↓
┌─────────────────────────────────────────────────────────────┐
│ UI層: app.py                                                 │
│ - _display_single_solution() で表示                         │
│ - _display_fleet_solution() でフリート全体を表示            │
│ - st.metric("エネルギー消費量 [kWh]", ...)                  │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 影響範囲

| コンポーネント | ファイル | 変更内容 | 影響度 |
|--------------|---------|---------|-------|
| データモデル | `src/services/master_repository.py` | VehicleCandidateにフィールド追加 | 中 |
| 車両カタログ | `src/services/vehicle_catalog.py` | VehicleTypeにフィールド・メソッド追加 | 中 |
| 最適化計算 | `src/services/optimizer.py` | _evaluate_cost()にロジック追加 | 低 |
| UI表示 | `src/app.py` | 表示関数にメトリクス追加 | 低 |
| マスターデータ | `data/processed/vehicles.json` | energy_consumption_kwh_per_km追加 | 高 |

---

## 5. データモデル設計

### 5.1 定数定義

**ファイル**: `src/services/master_repository.py`（推奨配置）

```python
# 燃料エネルギー密度定数（kWh/L）
# 出典: 国際エネルギー機関（IEA）
FUEL_ENERGY_DENSITY_KWH_PER_L = {
    "ガソリン": 8.8,   # レギュラーガソリンの低位発熱量
    "軽油": 10.0,      # ディーゼル燃料の低位発熱量
    "電気": 1.0,       # 電気の場合は直接kWhで指定
}

# 燃料タイプの別名対応（将来的な拡張）
FUEL_TYPE_ALIASES = {
    "gasoline": "ガソリン",
    "diesel": "軽油",
    "electric": "電気",
    "ev": "電気",
}
```

### 5.2 VehicleCandidateクラス

**ファイル**: `src/services/master_repository.py`

```python
from dataclasses import dataclass
from typing import Optional, Dict

@dataclass
class VehicleCandidate:
    """車両マスターデータ"""

    # 既存フィールド
    name: str
    fuel_type: str  # "ガソリン", "軽油", "電気"
    license: Optional[str]
    capacity_kg: Optional[float]
    load_volume_m3: Optional[float]
    fuel_efficiency_km_per_l: Optional[float]  # 燃費（km/L）
    annual_distance_km: Optional[float]
    variable_cost_per_km: float
    variable_cost_breakdown: Optional[Dict[str, float]]
    annual_fixed_cost: float
    fixed_cost_per_km: float
    fixed_cost_breakdown: Optional[Dict[str, float]]
    remarks: Optional[str]
    raw: Optional[Dict[str, object]]

    # ✨ 新規追加フィールド
    energy_consumption_kwh_per_km: Optional[float] = None  # kWh/km

    def __post_init__(self):
        """
        燃費データからエネルギー消費量を自動計算

        優先順位:
        1. energy_consumption_kwh_per_km が明示的に指定されていればそれを使用
        2. なければ fuel_efficiency_km_per_l から計算
        3. どちらもなければ 0.0
        """
        if self.energy_consumption_kwh_per_km is None:
            if self.fuel_efficiency_km_per_l and self.fuel_efficiency_km_per_l > 0:
                # 燃料消費量 (L/km) を計算
                fuel_consumption_l_per_km = 1.0 / self.fuel_efficiency_km_per_l

                # 燃料タイプに対応するエネルギー密度を取得
                energy_density = FUEL_ENERGY_DENSITY_KWH_PER_L.get(
                    self.fuel_type,
                    0  # 未知の燃料タイプの場合は0
                )

                # エネルギー消費量 (kWh/km) を計算
                self.energy_consumption_kwh_per_km = (
                    fuel_consumption_l_per_km * energy_density
                )
            else:
                # 燃費データがない場合は0
                self.energy_consumption_kwh_per_km = 0.0

        # 負の値を防ぐ
        if self.energy_consumption_kwh_per_km < 0:
            self.energy_consumption_kwh_per_km = 0.0
```

**設計上の考慮点**:
- `__post_init__`で自動計算することで、データ整合性を保証
- 明示的な指定値が優先されるため、EV等の特殊ケースに対応可能
- 負の値チェックでデータ異常を防止

### 5.3 VehicleTypeクラス

**ファイル**: `src/services/vehicle_catalog.py`

```python
from dataclasses import dataclass

@dataclass(frozen=True)
class VehicleType:
    """最適化計算用の車両タイプ定義"""

    # 既存フィールド
    name: str
    capacity_kg: int
    fixed_cost: float
    per_km_cost: float
    fixed_cost_per_km: float = 0.0

    # ✨ 新規追加フィールド
    energy_consumption_kwh_per_km: float = 0.0  # kWh/km

    # 既存メソッド
    def distance_cost(self, distance_m: float) -> float:
        """変動費を計算"""
        return self.per_km_cost * (distance_m / 1000.0)

    def fixed_cost_for_distance(self, distance_m: float) -> float:
        """距離に応じた固定費を計算"""
        return self.fixed_cost + self.fixed_cost_per_km * (distance_m / 1000.0)

    # ✨ 新規追加メソッド
    def energy_consumption_kwh(self, distance_m: float) -> float:
        """
        走行距離からエネルギー消費量を計算

        Args:
            distance_m: 走行距離（メートル）

        Returns:
            エネルギー消費量（kWh）
        """
        distance_km = distance_m / 1000.0
        return self.energy_consumption_kwh_per_km * distance_km
```

**設計上の考慮点**:
- `frozen=True`のため、immutableな設計を維持
- `energy_consumption_kwh()`メソッドで計算ロジックをカプセル化
- 単位変換（m → km）を内部で処理

### 5.4 VehicleCatalogクラス

**ファイル**: `src/services/vehicle_catalog.py`

```python
@dataclass
class VehicleCatalog:
    """車両カタログ管理"""

    _vehicles: Dict[str, VehicleType] = field(default_factory=dict)
    _order: List[str] = field(default_factory=list)

    def add_vehicle(
        self,
        name: str,
        capacity: int,
        fixed_cost: float,
        per_km_cost: float,
        fixed_cost_per_km: float = 0.0,
        energy_consumption_kwh_per_km: float = 0.0,  # ✨ 新規パラメータ
    ) -> VehicleType:
        """車両を追加"""

        vehicle = VehicleType(
            name=name,
            capacity_kg=max(0, int(capacity)),
            fixed_cost=float(fixed_cost),
            per_km_cost=float(per_km_cost),
            fixed_cost_per_km=float(fixed_cost_per_km),
            energy_consumption_kwh_per_km=float(energy_consumption_kwh_per_km),  # ✨
        )

        if name not in self._vehicles:
            self._order.append(name)
        self._vehicles[name] = vehicle
        return vehicle

    # ... 既存メソッド ...
```

**変更点**:
- `add_vehicle()`メソッドに`energy_consumption_kwh_per_km`パラメータを追加

---

## 6. 計算ロジック設計

### 6.1 _evaluate_cost関数の拡張

**ファイル**: `src/services/optimizer.py`

```python
def _evaluate_cost(
    vehicle: VehicleType,
    distance_m: float,
    vehicle_metadata: Optional[VehicleCandidate] = None
) -> Dict[str, float]:
    """
    車両のコストとエネルギー消費量を評価

    Args:
        vehicle: 最適化用の車両タイプ
        distance_m: 走行距離（メートル）
        vehicle_metadata: 詳細内訳情報（オプション）

    Returns:
        コストとエネルギー消費量を含む辞書:
        - fixed_cost: 固定費（円）
        - distance_cost: 変動費（円）
        - total_cost: 総コスト（円）
        - distance_km: 走行距離（km）
        - energy_consumption_kwh: エネルギー消費量（kWh）★新規
        - 変動費_XXX: 変動費詳細（円）
        - 固定費_XXX: 固定費詳細（円）
    """
    distance_km = distance_m / 1000.0

    # 既存のコスト計算
    variable_cost = vehicle.distance_cost(distance_m)
    fixed_cost = vehicle.fixed_cost_for_distance(distance_m)
    total_cost = fixed_cost + variable_cost

    # 基本結果辞書
    result = {
        "fixed_cost": int(fixed_cost),
        "distance_cost": int(variable_cost),
        "total_cost": int(total_cost),
        "distance_km": distance_km,
    }

    # ✨ 新規追加: エネルギー消費量計算
    if vehicle.energy_consumption_kwh_per_km > 0:
        energy_kwh = vehicle.energy_consumption_kwh(distance_m)
        result["energy_consumption_kwh"] = round(energy_kwh, 3)  # 小数点3桁で丸め

    # 既存の詳細内訳計算（変動費・固定費）
    if vehicle_metadata is None:
        return result

    # 変動費詳細
    if vehicle_metadata.variable_cost_breakdown:
        for item_name, unit_cost in vehicle_metadata.variable_cost_breakdown.items():
            try:
                key = f"変動費_{item_name}"
                result[key] = int(float(unit_cost) * distance_km)
            except (ValueError, TypeError):
                continue

    # 固定費詳細
    if vehicle_metadata.fixed_cost_breakdown and vehicle_metadata.annual_distance_km:
        if vehicle_metadata.annual_distance_km > 0:
            for item_name, annual_manyen in vehicle_metadata.fixed_cost_breakdown.items():
                try:
                    annual_yen = float(annual_manyen) * 10000  # 万円 → 円
                    per_km = annual_yen / vehicle_metadata.annual_distance_km
                    key = f"固定費_{item_name}"
                    result[key] = int(per_km * distance_km)
                except (ValueError, TypeError, ZeroDivisionError):
                    continue

    return result
```

**設計上の考慮点**:
- エネルギー消費量は `energy_consumption_kwh_per_km > 0` の場合のみ計算
- 小数点3桁で丸めることで、精度と可読性のバランスを取る
- 既存のコスト計算ロジックに影響を与えない

### 6.2 solve_fleet_routing関数の対応

**ファイル**: `src/services/optimizer.py`

```python
def solve_fleet_routing(
    distance_matrix: DistanceMatrix,
    depot: str,
    sink: str,
    assignments: Sequence[Tuple[VehicleType, Sequence[PickupInput]]],
    vehicle_metadata_map: Optional[Dict[str, VehicleCandidate]] = None,
) -> Union[FleetSolution, NoSolution]:
    """
    フリート全体のルート最適化

    エネルギー消費量は各車両の結果を自動的に集計
    """
    routes: List[VehicleRoute] = []
    totals: Dict[str, float] = defaultdict(float)

    for vehicle, pickup_group in assignments:
        # ... ピックアップデータの正規化 ...

        # 単一車両のルート最適化
        result = solve_routing(
            distance_matrix,
            payload,
            depot,
            sink,
            [vehicle],
            vehicle_metadata_map
        )

        if isinstance(result, NoSolution):
            return result

        routes.append(
            VehicleRoute(
                vehicle=result.vehicle,
                pickups=[entry["id"] for entry in payload],
                solution=result,
            )
        )

        # ✨ エネルギー消費量を含むすべてのメトリクスを集計
        for key, value in result.cost_breakdown.items():
            totals[key] += float(value)

    if not routes:
        return NoSolution(NoSolutionReason.INFEASIBLE, "回収対象の割り当てが見つかりません。")

    # デフォルト値の設定
    totals.setdefault("fixed_cost", 0.0)
    totals.setdefault("distance_cost", 0.0)
    totals.setdefault("total_cost", totals["fixed_cost"] + totals["distance_cost"])

    # energy_consumption_kwhは各車両の合計が自動的に totals に含まれる

    return FleetSolution(routes=routes, cost_breakdown=dict(totals))
```

**設計上の考慮点**:
- `totals`辞書で全メトリクスを自動集計するため、エネルギー消費量も自動的に合計される
- 特別な処理を追加する必要がない

---

## 7. UI/UX設計

### 7.1 単一車両の結果表示

**ファイル**: `src/app.py`

```python
def _display_single_solution(
    graph,
    solution: Solution,
    show_banner: bool = True,
    label_prefix: str = "",
    show_vehicle_info: bool = True
) -> None:
    """
    単一車両の最適化結果を表示
    """
    if show_banner:
        st.success("最適化が完了しました。")

    metric_prefix = f"{label_prefix}" if label_prefix else ""

    # 既存メトリクス
    st.metric(
        f"{metric_prefix}総距離 [km]",
        f"{solution.total_distance_m / 1000:.2f}"
    )
    st.metric(
        f"{metric_prefix}総コスト [円]",
        f"{solution.cost_breakdown.get('total_cost', 0):,.0f}"
    )

    # ✨ 新規追加: エネルギー消費量メトリクス
    energy_kwh = solution.cost_breakdown.get("energy_consumption_kwh")
    if energy_kwh and energy_kwh > 0:
        st.metric(
            f"{metric_prefix}エネルギー消費量 [kWh]",
            f"{energy_kwh:.2f}"
        )

    if show_vehicle_info:
        st.write("採用車種:", solution.vehicle.name)
    st.write("ルート順:", " → ".join(solution.order))

    # 既存のコスト内訳テーブル
    breakdown_rows = [
        {"項目": "固定費", "金額": solution.cost_breakdown.get("fixed_cost", 0.0)},
        {"項目": "距離費", "金額": solution.cost_breakdown.get("distance_cost", 0.0)},
        {"項目": "総額", "金額": solution.cost_breakdown.get("total_cost", 0.0)},
    ]
    if pd is not None:
        st.table(pd.DataFrame(breakdown_rows))
    else:
        st.write(breakdown_rows)

    # 詳細コスト内訳の表示（既存機能）
    _display_detailed_cost_breakdown(solution.cost_breakdown, solution.vehicle.name)

    # 地図表示（既存機能）
    # ...
```

**UI設計の考慮点**:
- エネルギー消費量は、データが存在する場合のみ表示（`if energy_kwh and energy_kwh > 0`）
- 既存のメトリクス表示と同じスタイルで統一感を保つ
- `label_prefix`を活用してフリート表示時にも対応

### 7.2 フリート全体の結果表示

**ファイル**: `src/app.py`

```python
def _display_fleet_solution(
    graph,
    fleet_solution: FleetSolution,
    plan_summary: Optional[Sequence[Dict[str, object]]] = None,
) -> None:
    """
    フリート全体の最適化結果を表示
    """
    st.success("複数車両で最適化が完了しました。")

    # 既存メトリクス
    st.metric(
        "総距離 [km]",
        f"{fleet_solution.total_distance_m / 1000:.2f}"
    )
    st.metric(
        "総コスト [円]",
        f"{fleet_solution.cost_breakdown.get('total_cost', 0):,.0f}"
    )

    # ✨ 新規追加: フリート全体のエネルギー消費量
    total_energy_kwh = fleet_solution.cost_breakdown.get("energy_consumption_kwh", 0)
    if total_energy_kwh > 0:
        st.metric(
            "総エネルギー消費量 [kWh]",
            f"{total_energy_kwh:.2f}"
        )

    # コスト内訳テーブル（既存機能）
    breakdown_rows = [
        {"項目": "固定費", "金額": fleet_solution.cost_breakdown.get("fixed_cost", 0.0)},
        {"項目": "距離費", "金額": fleet_solution.cost_breakdown.get("distance_cost", 0.0)},
        {"項目": "総額", "金額": fleet_solution.cost_breakdown.get("total_cost", 0.0)},
    ]
    if pd is not None:
        st.table(pd.DataFrame(breakdown_rows))
    else:
        st.write(breakdown_rows)

    # フリート全体の詳細コスト内訳（既存機能）
    if fleet_solution.routes:
        _display_detailed_cost_breakdown(
            fleet_solution.cost_breakdown,
            "フリート全体"
        )

    # 各車両の詳細表示（既存機能）
    for idx, route in enumerate(fleet_solution.routes, start=1):
        st.subheader(f"車両 {idx}: {route.vehicle.name}")
        # ...
        _display_single_solution(
            graph,
            route.solution,
            show_banner=False,
            label_prefix=f"車両{idx} ",
            show_vehicle_info=False,
        )
```

**UI設計の考慮点**:
- フリート全体のエネルギー消費量を最上部に表示
- 各車両の詳細にもエネルギー消費量が含まれる（`_display_single_solution`を再利用）

### 7.3 表示例

#### 単一車両の場合

```
✅ 最適化が完了しました

┌─────────────────────────┬─────────────┐
│ 総距離 [km]              │ 45.23       │
├─────────────────────────┼─────────────┤
│ 総コスト [円]            │ 15,840      │
├─────────────────────────┼─────────────┤
│ エネルギー消費量 [kWh]   │ 53.21       │ ★新規
└─────────────────────────┴─────────────┘

採用車種: 2t平ボディ
ルート順: depot → pickup1 → pickup2 → sink → depot
```

#### フリート全体の場合

```
✅ 複数車両で最適化が完了しました

┌──────────────────────────┬─────────────┐
│ 総距離 [km]               │ 98.47       │
├──────────────────────────┼─────────────┤
│ 総コスト [円]             │ 34,280      │
├──────────────────────────┼─────────────┤
│ 総エネルギー消費量 [kWh]  │ 112.85      │ ★新規
└──────────────────────────┴─────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
車両 1: 2t平ボディ

車両1 総距離 [km]: 45.23
車両1 総コスト [円]: 15,840
車両1 エネルギー消費量 [kWh]: 53.21  ★新規

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
車両 2: 4t平ボディ

車両2 総距離 [km]: 53.24
車両2 総コスト [円]: 18,440
車両2 エネルギー消費量 [kWh]: 59.64  ★新規
```

---

## 8. データ準備

### 8.1 vehicles.jsonへのデータ追加

**ファイル**: `data/processed/vehicles.json`

#### 計算方法

各車両について、以下の手順でエネルギー消費量を計算：

1. 燃費データを取得: `fuel_efficiency_km_per_l`
2. 燃料タイプを確認: `fuel_type`
3. エネルギー密度を適用
4. 計算: `energy_consumption_kwh_per_km = (1 / fuel_efficiency_km_per_l) × エネルギー密度`

#### 全車両の計算結果

| 車両名 | 燃料タイプ | 燃費 (km/L) | エネルギー密度 (kWh/L) | **エネルギー消費量 (kWh/km)** |
|--------|-----------|------------|---------------------|----------------------------|
| 軽トラック | ガソリン | 14.5 | 8.8 | **0.607** |
| 2t平ボディ | 軽油 | 8.5 | 10.0 | **1.176** |
| 2tダンプ | 軽油 | 8.0 | 10.0 | **1.250** |
| 4t平ボディ | 軽油 | 6.5 | 10.0 | **1.538** |
| 4tダンプ | 軽油 | 6.5 | 10.0 | **1.538** |
| 4tユニック | 軽油 | 6.0 | 10.0 | **1.667** |
| 4tウイング | 軽油 | 6.5 | 10.0 | **1.538** |
| 4tパッカー | 軽油 | 6.0 | 10.0 | **1.667** |
| 4tアームロール | 軽油 | 6.5 | 10.0 | **1.538** |
| 10t平ボディ | 軽油 | 4.25 | 10.0 | **2.353** |
| 10tダンプ | 軽油 | 4.25 | 10.0 | **2.353** |
| 10tウイング | 軽油 | 4.25 | 10.0 | **2.353** |
| 大型パッカー | 軽油 | 4.25 | 10.0 | **2.353** |
| バキューム車(4t) | 軽油 | 6.0 | 10.0 | **1.667** |

#### JSON追加例

```json
{
  "vehicles": [
    {
      "name": "軽トラック",
      "fuel_type": "ガソリン",
      "fuel_efficiency_km_per_l": 14.5,
      "energy_consumption_kwh_per_km": 0.607,
      "capacity_kg": 350.0,
      ...
    },
    {
      "name": "2t平ボディ",
      "fuel_type": "軽油",
      "fuel_efficiency_km_per_l": 8.5,
      "energy_consumption_kwh_per_km": 1.176,
      "capacity_kg": 2000.0,
      ...
    }
  ]
}
```

### 8.2 データ追加スクリプト（オプション）

自動計算スクリプトを作成する場合:

**ファイル**: `scripts/add_energy_consumption.py`

```python
#!/usr/bin/env python3
"""
vehicles.jsonにエネルギー消費量を追加するスクリプト
"""
import json
from pathlib import Path

# エネルギー密度定数
FUEL_ENERGY_DENSITY = {
    "ガソリン": 8.8,
    "軽油": 10.0,
    "電気": 1.0,
}

def calculate_energy_consumption(fuel_type: str, fuel_efficiency: float) -> float:
    """エネルギー消費量を計算"""
    if fuel_efficiency <= 0:
        return 0.0

    fuel_l_per_km = 1.0 / fuel_efficiency
    energy_density = FUEL_ENERGY_DENSITY.get(fuel_type, 0)
    return round(fuel_l_per_km * energy_density, 3)

def main():
    # vehicles.jsonを読み込み
    json_path = Path("data/processed/vehicles.json")

    with json_path.open("r", encoding="utf-8") as f:
        data = json.load(f)

    # 各車両にエネルギー消費量を追加
    for vehicle in data.get("vehicles", []):
        fuel_type = vehicle.get("fuel_type")
        fuel_efficiency = vehicle.get("fuel_efficiency_km_per_l")

        if fuel_type and fuel_efficiency:
            energy_kwh_per_km = calculate_energy_consumption(fuel_type, fuel_efficiency)
            vehicle["energy_consumption_kwh_per_km"] = energy_kwh_per_km
            print(f"{vehicle['name']}: {energy_kwh_per_km:.3f} kWh/km")
        else:
            vehicle["energy_consumption_kwh_per_km"] = 0.0
            print(f"{vehicle['name']}: データ不足のため0.0")

    # 保存
    with json_path.open("w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

    print(f"\n✅ {json_path} を更新しました")

if __name__ == "__main__":
    main()
```

**実行方法**:
```bash
python scripts/add_energy_consumption.py
```

---

## 9. 実装手順

### 9.1 実装フェーズ

| フェーズ | タスク | 所要時間（目安） |
|---------|-------|---------------|
| **Phase 1** | データモデル拡張 | 1-2時間 |
| **Phase 2** | 計算ロジック実装 | 1時間 |
| **Phase 3** | UI表示実装 | 1時間 |
| **Phase 4** | データ準備 | 30分 |
| **Phase 5** | テスト・検証 | 1-2時間 |
| **合計** | | **4.5-6.5時間** |

### 9.2 詳細実装ステップ

#### Phase 1: データモデル拡張

**ステップ 1.1**: `master_repository.py`に定数を追加
```python
# ファイル冒頭に追加
FUEL_ENERGY_DENSITY_KWH_PER_L = {
    "ガソリン": 8.8,
    "軽油": 10.0,
    "電気": 1.0,
}
```

**ステップ 1.2**: `VehicleCandidate`クラスを拡張
```python
# energy_consumption_kwh_per_km フィールドを追加
# __post_init__ メソッドを実装
```

**ステップ 1.3**: `VehicleType`クラスを拡張
```python
# energy_consumption_kwh_per_km フィールドを追加
# energy_consumption_kwh() メソッドを追加
```

**ステップ 1.4**: `VehicleCatalog.add_vehicle()`を更新
```python
# energy_consumption_kwh_per_km パラメータを追加
```

#### Phase 2: 計算ロジック実装

**ステップ 2.1**: `optimizer.py`の`_evaluate_cost()`を更新
```python
# エネルギー消費量計算ロジックを追加
# result["energy_consumption_kwh"] を追加
```

**ステップ 2.2**: `app.py`の`_build_vehicle_catalog()`を更新
```python
# VehicleCatalog.add_vehicle() 呼び出し時に energy_consumption_kwh_per_km を渡す
```

#### Phase 3: UI表示実装

**ステップ 3.1**: `_display_single_solution()`を更新
```python
# エネルギー消費量メトリクスを追加
```

**ステップ 3.2**: `_display_fleet_solution()`を更新
```python
# フリート全体のエネルギー消費量メトリクスを追加
```

#### Phase 4: データ準備

**ステップ 4.1**: `vehicles.json`を手動編集または
```bash
# スクリプトで自動追加
python scripts/add_energy_consumption.py
```

**ステップ 4.2**: データ検証
```bash
# JSONの妥当性をチェック
python -m json.tool data/processed/vehicles.json > /dev/null && echo "OK"
```

#### Phase 5: テスト・検証

**ステップ 5.1**: 単体テスト実行
```bash
pytest tests/
```

**ステップ 5.2**: アプリ起動確認
```bash
run_app.bat
```

**ステップ 5.3**: 動作確認
- 単一車両での最適化
- 複数車両（フリート）での最適化
- エネルギー消費量の表示確認

---

## 10. テスト計画

### 10.1 単体テスト

#### テスト対象: `VehicleCandidate.__post_init__`

**テストケース**:

| ID | 条件 | 期待結果 |
|----|------|---------|
| TC-01 | `fuel_efficiency=14.5, fuel_type="ガソリン"` | `energy_consumption_kwh_per_km ≈ 0.607` |
| TC-02 | `fuel_efficiency=8.5, fuel_type="軽油"` | `energy_consumption_kwh_per_km ≈ 1.176` |
| TC-03 | `fuel_efficiency=None` | `energy_consumption_kwh_per_km = 0.0` |
| TC-04 | `fuel_efficiency=0` | `energy_consumption_kwh_per_km = 0.0` |
| TC-05 | `fuel_type="未知"` | `energy_consumption_kwh_per_km = 0.0` |
| TC-06 | `energy_consumption_kwh_per_km=1.5`（明示指定） | `energy_consumption_kwh_per_km = 1.5` |

#### テスト対象: `VehicleType.energy_consumption_kwh`

**テストケース**:

| ID | 条件 | 期待結果 |
|----|------|---------|
| TC-11 | `energy_consumption_kwh_per_km=1.176, distance_m=50000` | `≈ 58.8 kWh` |
| TC-12 | `energy_consumption_kwh_per_km=0, distance_m=50000` | `0.0 kWh` |
| TC-13 | `energy_consumption_kwh_per_km=1.0, distance_m=1000` | `1.0 kWh` |

#### テスト対象: `_evaluate_cost`

**テストケース**:

| ID | 条件 | 期待結果 |
|----|------|---------|
| TC-21 | `vehicle.energy_consumption_kwh_per_km=1.176, distance_m=45000` | `result["energy_consumption_kwh"] ≈ 52.92` |
| TC-22 | `vehicle.energy_consumption_kwh_per_km=0, distance_m=45000` | `"energy_consumption_kwh" not in result` |

### 10.2 統合テスト

#### テストシナリオ 1: 単一車両最適化

**手順**:
1. 軽トラックを選択
2. 回収地点を3箇所設定
3. 最適化を実行
4. エネルギー消費量が表示されることを確認

**期待結果**:
- エネルギー消費量 [kWh] メトリクスが表示される
- 値が正の数値である
- 走行距離との整合性がある（`energy ≈ distance × 0.607`）

#### テストシナリオ 2: フリート最適化

**手順**:
1. 2つの異なる資源を設定
2. 複数車両が割り当てられるようにする
3. 最適化を実行
4. フリート全体のエネルギー消費量が表示されることを確認

**期待結果**:
- 総エネルギー消費量が各車両の合計と一致
- 各車両の詳細にもエネルギー消費量が表示される

### 10.3 受け入れテスト

#### テスト項目

| ID | テスト項目 | 合格基準 |
|----|----------|---------|
| AT-01 | エネルギー消費量が正しく計算される | 手計算値との誤差 < 1% |
| AT-02 | UI表示が適切 | メトリクスが見やすく配置されている |
| AT-03 | 既存機能に影響なし | コスト計算結果が変わらない |
| AT-04 | 後方互換性 | 古いvehicles.jsonでも動作する |
| AT-05 | パフォーマンス | 計算時間の増加 < 100ms |

---

## 11. 運用とメンテナンス

### 11.1 データ更新手順

#### 新しい車両を追加する場合

1. `vehicles.json`に車両データを追加
2. `fuel_type`と`fuel_efficiency_km_per_l`を正確に設定
3. （オプション）`energy_consumption_kwh_per_km`を明示的に指定
4. データ検証スクリプトを実行

```bash
python scripts/validate_vehicles.py
```

#### EV（電気自動車）を追加する場合

```json
{
  "name": "電気トラック",
  "fuel_type": "電気",
  "fuel_efficiency_km_per_l": null,
  "energy_consumption_kwh_per_km": 1.2,  // kWh/kmを直接指定
  ...
}
```

### 11.2 トラブルシューティング

#### 問題: エネルギー消費量が表示されない

**原因と対処**:
1. `fuel_efficiency_km_per_l`が0またはNULL → データを確認
2. `fuel_type`が不正 → "ガソリン"または"軽油"であることを確認
3. `energy_consumption_kwh_per_km`が0 → 手動で設定

#### 問題: エネルギー消費量が異常に大きい/小さい

**原因と対処**:
1. `fuel_efficiency_km_per_l`の単位が間違っている → km/Lであることを確認
2. エネルギー密度定数が間違っている → 8.8 (ガソリン), 10.0 (軽油)を確認

### 11.3 監視とログ

推奨する監視項目:

- エネルギー消費量の計算時エラー
- 異常値の検出（負の値、極端に大きい値）
- NULL値の発生頻度

---

## 12. 将来の拡張性

### 12.1 CO2排出量計算

エネルギー消費量からCO2排出量を計算可能:

```python
# CO2排出係数（kg-CO2/kWh）
CO2_EMISSION_FACTOR = {
    "ガソリン": 0.249,  # kg-CO2/kWh
    "軽油": 0.257,      # kg-CO2/kWh
    "電気": 0.465,      # kg-CO2/kWh（日本の電力平均）
}

def calculate_co2_emission(fuel_type: str, energy_kwh: float) -> float:
    """CO2排出量を計算（kg）"""
    factor = CO2_EMISSION_FACTOR.get(fuel_type, 0)
    return energy_kwh * factor
```

### 12.2 燃料コストとの連携

エネルギー消費量から燃料コストを逆算:

```python
# 燃料価格（円/L）
FUEL_PRICE = {
    "ガソリン": 170,  # 円/L
    "軽油": 150,      # 円/L
}

def calculate_fuel_cost(fuel_type: str, energy_kwh: float) -> float:
    """燃料コストを計算（円）"""
    energy_density = FUEL_ENERGY_DENSITY_KWH_PER_L.get(fuel_type, 0)
    if energy_density == 0:
        return 0

    fuel_liters = energy_kwh / energy_density
    price_per_liter = FUEL_PRICE.get(fuel_type, 0)
    return fuel_liters * price_per_liter
```

### 12.3 再生可能エネルギー対応

電力の再生可能エネルギー比率を考慮:

```python
# 再生可能エネルギー比率（0.0-1.0）
RENEWABLE_RATIO = 0.2  # 20%

def calculate_renewable_energy(energy_kwh: float) -> float:
    """再生可能エネルギー消費量を計算（kWh）"""
    return energy_kwh * RENEWABLE_RATIO
```

### 12.4 グラフ表示

エネルギー消費量の時系列推移やヒストグラムを表示:

```python
import plotly.express as px

def plot_energy_consumption_history(history: List[Dict]):
    """エネルギー消費量の推移をグラフ表示"""
    df = pd.DataFrame(history)
    fig = px.line(df, x="date", y="energy_kwh", title="エネルギー消費量の推移")
    st.plotly_chart(fig)
```

---

## 13. 参考資料

### 13.1 エネルギー関連

- 国際エネルギー機関（IEA）統計データ
  - https://www.iea.org/
- 日本エネルギー経済研究所
  - https://eneken.ieej.or.jp/
- 資源エネルギー庁「総合エネルギー統計」
  - https://www.enecho.meti.go.jp/statistics/total_energy/

### 13.2 CO2排出係数

- 環境省「温室効果ガス排出量算定・報告・公表制度」
  - https://ghg-santeikohyo.env.go.jp/
- カーボンフットプリント通信
  - http://www.cfp-japan.jp/

### 13.3 技術文書

- OR-Tools公式ドキュメント
  - https://developers.google.com/optimization
- Streamlit公式ドキュメント
  - https://docs.streamlit.io/

### 13.4 関連規格

- ISO 14064: 温室効果ガスの定量化および報告
- ISO 14067: カーボンフットプリント

---

## 付録A: 計算精度の検証

### A.1 精度検証例

**検証対象**: 軽トラック（ガソリン、14.5 km/L）で45.23 km走行

**手計算**:
```
燃料消費量 = 45.23 / 14.5 = 3.12 L
エネルギー消費量 = 3.12 × 8.8 = 27.456 kWh
```

**システム計算**:
```python
energy_consumption_kwh_per_km = 1 / 14.5 * 8.8 = 0.607
energy_kwh = 0.607 * 45.23 = 27.454 kWh
```

**誤差**: `(27.456 - 27.454) / 27.456 = 0.007%` → ✅ 合格（< 1%）

---

## 付録B: データスキーマ定義

### B.1 vehicles.jsonスキーマ

```json
{
  "vehicles": [
    {
      "name": "string (必須)",
      "fuel_type": "string (必須: 'ガソリン' | '軽油' | '電気')",
      "fuel_efficiency_km_per_l": "number | null",
      "energy_consumption_kwh_per_km": "number (新規追加、オプション)",
      "capacity_kg": "number",
      "variable_cost_per_km": "number",
      "fixed_cost_per_km": "number",
      ...
    }
  ]
}
```

### B.2 cost_breakdownスキーマ

```python
{
    "fixed_cost": int,           # 固定費（円）
    "distance_cost": int,        # 変動費（円）
    "total_cost": int,           # 総コスト（円）
    "distance_km": float,        # 走行距離（km）
    "energy_consumption_kwh": float,  # ★新規: エネルギー消費量（kWh）
    "変動費_XXX": int,           # 変動費詳細
    "固定費_XXX": int,           # 固定費詳細
}
```

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|-------|
| 1.0 | 2025-11-18 | 初版作成 | Claude |

---

**以上**
