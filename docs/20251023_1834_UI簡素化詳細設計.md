# 資源回収ルート最適化ツール UI簡素化 詳細設計書

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| **文書名** | UI簡素化詳細設計書 |
| **作成日** | 2025年10月23日 18:34 |
| **対象システム** | 資源回収ルート最適化ツール |
| **バージョン** | v1.0 |
| **作成者** | Claude Code |
| **ステータス** | 設計中 |

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [設計目的と背景](#2-設計目的と背景)
3. [システム現状分析](#3-システム現状分析)
4. [設計方針](#4-設計方針)
5. [Phase別詳細設計](#5-phase別詳細設計)
6. [データフロー設計](#6-データフロー設計)
7. [UI/UX設計](#7-uiux設計)
8. [実装計画](#8-実装計画)
9. [テスト計画](#9-テスト計画)
10. [リスク管理](#10-リスク管理)
11. [品質保証](#11-品質保証)
12. [成果物](#12-成果物)

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
資源回収ルート最適化ツール UI簡素化プロジェクト

### 1.2 目的
現在のUIから冗長な要素を削除し、ユーザーが求める「シンプルで直感的なワークフロー」を実現する。

### 1.3 スコープ
- **対象ファイル**: `src/app.py` (メインUIロジック)
- **対象行数**: 約150-200行の削除・修正
- **影響範囲**: UIレイヤーのみ（ビジネスロジックは変更なし）

### 1.4 ゴール
ユーザーが以下のシンプルなフローで最適化を実行できるようにする：

```
車庫の指定
  ↓
回収地点の指定（資源種別、回収量のみ）
  ↓
集積場所の指定
  ↓
最適化実行
  ↓
ルートとコストの表示
```

---

## 2. 設計目的と背景

### 2.1 背景
現在のUIは、段階的な機能追加により以下の問題を抱えている：

1. **情報過多**: ユーザーが必要としない詳細情報が表示されている
2. **操作の複雑さ**: 同じ目的を達成する複数の方法が存在
3. **認知負荷**: 3つのタブ構造で、実質的に設定項目がないタブも存在
4. **視覚的ノイズ**: 適合性チェックや詳細表示が多すぎる

### 2.2 ユーザー要望
ユーザーは以下を明確に不要と指摘：

- 回収地点設定時の車種容量チェック、適合車種表示
- 選択状況の辞書表示
- ノードの手動選択プルダウン
- 車種設定タブ（設定するものがない）

### 2.3 設計目的
- **ユーザビリティ向上**: クリック数削減、認知負荷軽減
- **保守性向上**: コード量削減、構造の簡素化
- **パフォーマンス向上**: レンダリング要素の削減

---

## 3. システム現状分析

### 3.1 アーキテクチャ概要

**技術スタック**:
- フレームワーク: Streamlit
- 言語: Python 3.x
- 状態管理: st.session_state
- 地図表示: Folium + streamlit-folium

**ファイル構造**:
```
src/
├── app.py                    # メインUIロジック (1,631行)
├── services/                 # ビジネスロジック
│   ├── optimizer.py
│   ├── vehicle_catalog.py
│   └── point_registry.py
└── ui/                       # UIヘルパー（現在ほぼ未使用）
```

### 3.2 現在のタブ構造

```
タブ1: 📍 地点選択
├── 地図クリックモード選択
├── 地図表示
├── 回収地点ダイアログ
├── 回収地点一覧（詳細表示）
├── 選択状況表示（辞書形式）
└── ノード手動選択エクスパンダー

タブ2: 🚗 車種設定
├── 車種編集テーブル
├── 回収地点詳細設定
├── 車種割当プラン表示
└── 警告表示

タブ3: ⚡ 最適化実行
├── 実行前チェックリスト
├── 最適化ボタン
├── プログレスバー
└── 結果表示
```

### 3.3 セッション状態
現在管理している主要な状態：

| 状態キー | 型 | 用途 |
|---------|-----|------|
| `depot_id` | Optional[str] | 車庫ノードID |
| `sink_id` | Optional[str] | 集積場所ノードID |
| `pickup_selection` | List[str] | 回収地点ノードIDリスト |
| `pickup_attrs` | Dict | 回収地点属性（qty, resource） |
| `vehicles` | List[Dict] | 車種定義リスト |
| `vehicle_metadata` | Dict | 車種メタデータ |
| `fleet_plan` | List | 車種割当プラン |
| `latest_solution` | Dict | 最適化結果 |

---

## 4. 設計方針

### 4.1 基本方針

#### 4.1.1 削除の原則
- ユーザーが明示的に不要と指摘した要素は完全削除
- 代替手段が存在する機能は削除
- エラーハンドリングは最適化実行時に集約

#### 4.1.2 保持の原則
- コアワークフローに必要な要素は保持
- サイドバーの選択状況表示は便利なため保持
- 地図クリックによる選択機能は主要機能として保持

#### 4.1.3 移動の原則
- 車種割当プラン生成ロジックは最適化実行時に内部実行
- バリデーションは実行前チェックリストに集約

### 4.2 段階的実装戦略

#### 低リスク → 高リスクの順で実装

```
Phase 3, 4 (低リスク)
  ↓
Phase 1, 2 (中リスク)
  ↓
Phase 5 (高リスク)
```

各Phase完了後にテストを実施し、問題がないことを確認してから次のPhaseに進む。

### 4.3 品質基準

- **機能保持**: 既存の最適化機能は完全に保持
- **後方互換性**: セッション状態の構造は維持
- **エラーハンドリング**: 削除した事前チェックのエラーは実行時に表示
- **ユーザー体験**: クリック数を30%以上削減

---

## 5. Phase別詳細設計

### Phase 1: 回収地点ダイアログの簡素化

#### 5.1.1 概要
- **目的**: 回収量と資源種別のみのシンプルなダイアログに変更
- **対象ファイル**: `src/app.py`
- **対象関数**: `_render_pickup_dialog()` (lines 802-947)
- **影響範囲**: ダイアログ表示のみ
- **リスクレベル**: 中

#### 5.1.2 削除対象

**削除対象1**: 入力値ガイダンスと車種容量チェック (lines 844-854)

**Before**:
```python
# Phase 3-1: 入力値のガイダンス
if qty > 0:
    st.caption(f"💡 入力値: {qty}kg = {qty/1000:.2f}トン")

    # 車種容量との比較
    vehicles = st.session_state.get("vehicles", [])
    if vehicles:
        compatible_count = sum(1 for v in vehicles if v.get("capacity_kg", 0) >= qty)
        if compatible_count > 0:
            st.success(f"✅ {compatible_count}種類の車両で運搬可能です")
        else:
            st.error(f"❌ 現在の車種では容量不足です。車種設定を見直してください。")
```

**After**:
```python
# 削除（入力値ガイダンスは不要）
```

**削除対象2**: 資源-車種適合の可視化 (lines 869-896)

**Before**:
```python
# Phase 3-3: 資源-車種適合の可視化
if resource_value and master and master.compatibility:
    current_vehicle_names = {record.get("name") for record in st.session_state.get("vehicles", [])}
    compatible_vehicles = []
    incompatible_vehicles = []

    for name in current_vehicle_names:
        if not name:
            continue
        compat = master.compatibility.get(name)
        if not compat:
            continue
        status = compat.supports.get(resource_value)
        if status is True:
            compatible_vehicles.append(name)
        elif status is False:
            incompatible_vehicles.append(name)

    # 適合状況の表示
    if compatible_vehicles:
        st.success(f"✅ 適合車種: {', '.join(sorted(compatible_vehicles))}")

    if incompatible_vehicles:
        st.warning(f"⚠️ 非適合車種: {', '.join(sorted(incompatible_vehicles))}")
        st.caption("💡 この資源は上記の車種では運搬できません。他の車種を追加するか、資源種別を変更してください。")

    if not compatible_vehicles and not incompatible_vehicles:
        st.info("ℹ️ 適合情報がマスタに登録されていません。")
```

**After**:
```python
# 削除（適合チェックは不要）
```

**削除対象3**: helpテキストの簡略化 (line 840)

**Before**:
```python
qty = st.number_input(
    "回収量 (kg)",
    min_value=0,
    max_value=100000,
    step=50,
    value=max(0, default_qty),
    key=qty_key,
    help="回収する資源の重量をキログラム単位で入力してください。50kg刻みで入力できます。"
)
```

**After**:
```python
qty = st.number_input(
    "回収量 (kg)",
    min_value=0,
    max_value=100000,
    step=50,
    value=max(0, default_qty),
    key=qty_key,
)
```

#### 5.1.3 修正後の完全なコード

```python
def _render_pickup_dialog(master: Optional[ProcessedMasterData]) -> None:
    """回収地点追加ダイアログ（簡素化版）"""
    if not st.session_state.get("pickup_dialog_open"):
        return

    pending = st.session_state.get("pending_pickup")
    if not isinstance(pending, dict) or not pending.get("node_id"):
        _clear_pending_pickup()
        return

    node_id = str(pending.get("node_id"))
    label = str(pending.get("label") or node_id)

    resource_names = sorted(master.resources.keys()) if master and master.resources else []
    defaults = st.session_state.get("pending_pickup_defaults", {})
    default_qty = int(defaults.get("qty", 100)) if isinstance(defaults, dict) else 100
    default_resource = ""
    if isinstance(defaults, dict):
        default_resource = str(defaults.get("resource") or "")
    if not default_resource and resource_names:
        default_resource = resource_names[0]

    def _dialog_body() -> None:
        st.subheader("回収地点の追加")
        st.caption(f"ノード: {label}")

        form_key = f"pickup_dialog_form_{node_id}"
        qty_key = f"pickup_dialog_qty_{node_id}"
        resource_key = f"pickup_dialog_resource_{node_id}"

        with st.form(form_key, clear_on_submit=False):
            # シンプルな回収量入力
            qty = st.number_input(
                "回収量 (kg)",
                min_value=0,
                max_value=100000,
                step=50,
                value=max(0, default_qty),
                key=qty_key,
            )

            # 資源種別選択
            resource_value = ""
            if resource_names:
                try:
                    index = resource_names.index(default_resource)
                except ValueError:
                    index = 0
                resource_value = st.selectbox(
                    "資源種別",
                    resource_names,
                    index=index,
                    key=resource_key,
                )
            else:
                st.warning("資源マスタが未登録です。先に設定してください。")

            # 追加/キャンセルボタン
            col_add, col_cancel = st.columns(2)
            submit_add = col_add.form_submit_button("追加", use_container_width=True)
            submit_cancel = col_cancel.form_submit_button("キャンセル", use_container_width=True)

        if submit_cancel:
            _clear_pending_pickup()
            _toast("回収地点の追加をキャンセルしました。", icon="ℹ️")
            return

        if submit_add:
            if qty <= 0:
                st.warning("量は1以上を指定してください。")
                return
            if not resource_names:
                st.warning("資源種別を追加できません。資源マスタを確認してください。")
                return
            resource = str(resource_value or default_resource or resource_names[0])
            _finalise_pending_pickup(node_id, resource, int(qty))

    # Streamlitダイアログの表示
    dialog_factory = getattr(st, "dialog", None) or getattr(st, "experimental_dialog", None)
    if callable(dialog_factory):
        dialog_decorator = dialog_factory("回収地点の設定")
        if callable(dialog_decorator):
            @dialog_decorator
            def _dialog_wrapper() -> None:
                _dialog_body()
            _dialog_wrapper()
        else:
            placeholder = st.empty()
            def _render_inline():
                with placeholder.container():
                    _dialog_body()
            _render_inline()
    else:
        placeholder = st.empty()
        def _render_inline():
            with placeholder.container():
                _dialog_body()
        _render_inline()
```

#### 5.1.4 期待される効果
- **コード削減**: 約60行削除
- **視覚的シンプル化**: ダイアログ内の表示要素が半減
- **認知負荷軽減**: 必要最小限の情報のみ表示

---

### Phase 2: 回収地点一覧の簡素化

#### 5.2.1 概要
- **目的**: エクスパンダー内の適合情報と詳細サマリーを削除
- **対象ファイル**: `src/app.py`
- **対象箇所**: lines 1249-1365
- **影響範囲**: 回収地点一覧表示
- **リスクレベル**: 中

#### 5.2.2 削除対象

**削除対象1**: 資源-車種適合の可視化 (lines 1279-1299)

**Before**:
```python
# Phase 3-3: 資源-車種適合の可視化
if new_resource and processed_master and processed_master.compatibility:
    current_vehicle_names = {record.get("name") for record in st.session_state.get("vehicles", [])}
    compatible_vehicles = []
    incompatible_vehicles = []

    for name in current_vehicle_names:
        if not name:
            continue
        compat = processed_master.compatibility.get(name)
        if not compat:
            continue
        status = compat.supports.get(new_resource)
        if status is True:
            compatible_vehicles.append(name)
        elif status is False:
            incompatible_vehicles.append(name)

    # 適合状況の表示
    if compatible_vehicles:
        st.caption(f"✅ 適合車種: {', '.join(sorted(compatible_vehicles))}")
```

**After**:
```python
# 削除（適合表示は不要）
```

**削除対象2**: 資源情報の詳細サマリー (lines 1350-1355)

**Before**:
```python
if processed_master and processed_master.resources:
    resource_info = processed_master.resources.get(new_resource)
    if resource_info:
        summary_lines = _resource_summary(resource_info)
        if summary_lines:
            st.caption(" / ".join(summary_lines))
```

**After**:
```python
# 削除（詳細サマリーは不要）
```

#### 5.2.3 修正後のコード（回収地点一覧部分）

```python
# Phase 2-5: 回収地点一覧の改善（簡素化版）
pickup_selection = st.session_state.get("pickup_selection", [])
if pickup_selection:
    st.markdown("---")
    st.subheader("📦 選択済み回収地点")

    # 各地点をカード形式で表示
    for idx, point_id in enumerate(pickup_selection, start=1):
        attrs = st.session_state.get("pickup_attrs", {}).get(point_id, {})
        qty = attrs.get("qty", 0)
        resource = attrs.get("resource") or attrs.get("kind", "未設定")

        # エクスパンダーで展開可能
        with st.expander(f"#{idx} {point_id} - {resource} {qty}kg", expanded=False):
            col1, col2, col3 = st.columns([3, 3, 1])

            # 資源種別の再選択
            resource_names = sorted(processed_master.resources.keys()) if processed_master and processed_master.resources else []
            if resource_names:
                try:
                    default_index = resource_names.index(resource)
                except ValueError:
                    default_index = 0
                new_resource = col1.selectbox(
                    "資源種別",
                    resource_names,
                    index=default_index,
                    key=f"edit_resource_{point_id}"
                )

                # 回収量の再入力
                new_qty = col2.number_input(
                    "回収量 (kg)",
                    min_value=0,
                    max_value=100000,
                    step=50,
                    value=max(0, qty),
                    key=f"edit_qty_{point_id}"
                )

                # 更新・削除ボタン
                if col3.button("更新", key=f"update_{point_id}"):
                    pickup_attrs = st.session_state.get("pickup_attrs", {})
                    pickup_attrs[point_id] = {"qty": new_qty, "resource": new_resource, "kind": new_resource}
                    st.session_state["pickup_attrs"] = pickup_attrs
                    st.success(f"✅ {point_id} を更新しました")
                    st.rerun()

                if col3.button("🗑️", key=f"delete_{point_id}"):
                    pickup_selection = st.session_state.get("pickup_selection", [])
                    if point_id in pickup_selection:
                        pickup_selection.remove(point_id)
                        st.session_state["pickup_selection"] = pickup_selection
                    pickup_attrs = st.session_state.get("pickup_attrs", {})
                    if point_id in pickup_attrs:
                        del pickup_attrs[point_id]
                        st.session_state["pickup_attrs"] = pickup_attrs
                    st.success(f"🗑️ {point_id} を削除しました")
                    if st.session_state.get("last_selected_node") == point_id:
                        _set_last_selection(None, None)
                    st.rerun()

    # 一括削除ボタン
    if st.button("🗑️ すべての回収地点をクリア", key="pickup_clear_all"):
        st.session_state["pickup_selection"] = []
        st.session_state["pickup_attrs"] = {}
        _clear_pending_pickup()
        st.success("🗑️ すべての回収地点を削除しました")
        if st.session_state.get("last_selected_role") == "pickup":
            _set_last_selection(None, None)
        st.rerun()
```

#### 5.2.4 期待される効果
- **コード削減**: 約30行削除
- **視覚的シンプル化**: エクスパンダー内の情報が整理される
- **編集の容易さ**: 必要な情報のみに集中

---

### Phase 3: 選択状況表示の削除

#### 5.3.1 概要
- **目的**: メインエリアの冗長な辞書表示を削除
- **対象ファイル**: `src/app.py`
- **対象箇所**: lines 1371-1378
- **影響範囲**: タブ1の選択状況表示
- **リスクレベル**: 低

#### 5.3.2 削除対象

**Before**:
```python
depot_id = st.session_state.get("depot_id")
sink_id = st.session_state.get("sink_id")
pickup_selection = st.session_state.get("pickup_selection", [])

st.write(
    "**選択状況**",
    {
        "車庫": depot_id,
        "集積": sink_id,
        "回収": pickup_selection,
    },
)
```

**After**:
```python
# 削除（サイドバーで選択状況を確認できるため不要）
depot_id = st.session_state.get("depot_id")
sink_id = st.session_state.get("sink_id")
pickup_selection = st.session_state.get("pickup_selection", [])
```

**注意**: 変数の取得は維持（後続のコードで使用されているため）

#### 5.3.3 期待される効果
- **コード削減**: 8行削除
- **視覚的シンプル化**: 冗長な表示がなくなる
- **実装時間**: 1分

---

### Phase 4: ノード手動選択の削除

#### 5.4.1 概要
- **目的**: 手動選択エクスパンダーを完全削除
- **対象ファイル**: `src/app.py`
- **対象箇所**: lines 1380-1411
- **影響範囲**: タブ1の手動選択エクスパンダー
- **リスクレベル**: 低

#### 5.4.2 削除対象

**Before**:
```python
# Manual selectors for細かな微調整
with st.expander("ノードを手動で選択", expanded=False):
    depot_select = st.selectbox(
        "車庫ノード (手動)",
        node_ids,
        index=node_ids.index(depot_id) if depot_id in node_ids else 0,
        key="depot_select_manual",
    )
    if depot_select != depot_id:
        st.session_state["depot_id"] = depot_select
        _set_last_selection(depot_select, "depot")

    sink_select = st.selectbox(
        "集積ノード (手動)",
        node_ids,
        index=node_ids.index(sink_id) if sink_id in node_ids else 0,
        key="sink_select_manual",
    )
    if sink_select != sink_id:
        st.session_state["sink_id"] = sink_select
        _set_last_selection(sink_select, "sink")

    manual_pickups = st.multiselect(
        "回収ノード (手動)",
        [nid for nid in node_ids if nid not in {st.session_state["depot_id"], st.session_state["sink_id"]}],
        default=[p for p in pickup_selection if p in node_ids],
        key="pickup_select_manual",
    )
    if sorted(manual_pickups) != sorted(pickup_selection):
        st.session_state["pickup_selection"] = manual_pickups
        last_manual = manual_pickups[-1] if manual_pickups else None
        _set_last_selection(last_manual, "pickup" if last_manual else None)
```

**After**:
```python
# 削除（地図クリックのみで選択を行う）
```

#### 5.4.3 期待される効果
- **コード削減**: 32行削除
- **視覚的シンプル化**: エクスパンダーが消える
- **操作の一貫性**: 地図クリックのみで選択
- **実装時間**: 1分

---

### Phase 5: 車種設定タブの削除

#### 5.5.1 概要
- **目的**: タブ2（車種設定）を削除し、2タブ構造に変更
- **対象ファイル**: `src/app.py`
- **対象箇所**: lines 1164, 1413-1485
- **影響範囲**: タブ構造全体
- **リスクレベル**: 高

#### 5.5.2 変更内容

**変更1**: タブ構造の変更 (line 1164)

**Before**:
```python
# Phase 2: タブ構造の導入
tab1, tab2, tab3 = st.tabs(["📍 1. 地点選択", "🚗 2. 車種設定", "⚡ 3. 最適化実行"])
```

**After**:
```python
# 簡素化されたタブ構造（2タブ）
tab1, tab2 = st.tabs(["📍 地点選択", "⚡ 最適化実行"])
```

**変更2**: タブ2（車種設定）の完全削除 (lines 1413-1485)

**Before**:
```python
# === タブ2: 車種設定 ===
with tab2:
    st.markdown("### 車種候補の設定")

    _render_vehicle_editor(processed_master)

    st.markdown("---")

    # 回収地点の資源種別・数量入力
    pickup_selection = st.session_state.get("pickup_selection", [])
    if pickup_selection:
        st.markdown("### 回収地点の詳細設定")
        pickup_inputs = _collect_pickup_inputs(pickup_selection, processed_master)
    else:
        st.info("📍 先に「1. 地点選択」タブで回収地点を選択してください。")
        pickup_inputs = []

    # 車種割当プラン生成
    vehicle_plan, plan_warnings = _plan_vehicle_allocations(
        st.session_state["vehicles"],
        processed_master,
        pickup_inputs,
    )
    st.session_state["vehicle_filter_warnings"] = list(dict.fromkeys(plan_warnings))
    st.session_state["fleet_plan"] = vehicle_plan

    # 警告表示
    for warning in st.session_state.get("vehicle_filter_warnings", []):
        st.warning(warning, icon="⚠️")

    # Phase 1-4: 車種割当プランのデフォルト表示
    if vehicle_plan:
        st.markdown("---")
        st.subheader("📋 車種割当プラン")

        # テーブル形式で表示
        plan_rows = []
        # ... (プラン表示ロジック)
```

**After**:
```python
# 削除（タブ2全体）
```

**変更3**: タブ3をタブ2に変更し、車種割当プラン生成を内部化

**Before**:
```python
# === タブ3: 最適化実行 ===
with tab3:
    st.markdown("### 最適化の実行")

    # セッション状態から必要な値を取得
    depot_id = st.session_state.get("depot_id")
    sink_id = st.session_state.get("sink_id")
    pickup_selection = st.session_state.get("pickup_selection", [])
    vehicle_plan = st.session_state.get("fleet_plan", [])
    catalog = _build_vehicle_catalog(st.session_state["vehicles"])
    vehicles_defined = catalog.list_vehicles()
```

**After**:
```python
# === タブ2: 最適化実行 ===
with tab2:
    st.markdown("### 最適化の実行")

    # セッション状態から必要な値を取得
    depot_id = st.session_state.get("depot_id")
    sink_id = st.session_state.get("sink_id")
    pickup_selection = st.session_state.get("pickup_selection", [])

    # 車種割当プラン生成（内部で自動実行）
    pickup_inputs = []
    if pickup_selection:
        pickup_inputs = _collect_pickup_inputs(pickup_selection, processed_master)

    vehicle_plan, plan_warnings = _plan_vehicle_allocations(
        st.session_state["vehicles"],
        processed_master,
        pickup_inputs,
    )
    st.session_state["vehicle_filter_warnings"] = list(dict.fromkeys(plan_warnings))
    st.session_state["fleet_plan"] = vehicle_plan

    catalog = _build_vehicle_catalog(st.session_state["vehicles"])
    vehicles_defined = catalog.list_vehicles()
```

#### 5.5.3 ロジックの移動

車種割当プラン生成ロジックを最適化実行タブに移動：

```python
# 最適化実行前に車種割当プランを自動生成
pickup_inputs = []
if pickup_selection:
    pickup_inputs = _collect_pickup_inputs(pickup_selection, processed_master)

vehicle_plan, plan_warnings = _plan_vehicle_allocations(
    st.session_state["vehicles"],
    processed_master,
    pickup_inputs,
)
st.session_state["vehicle_filter_warnings"] = list(dict.fromkeys(plan_warnings))
st.session_state["fleet_plan"] = vehicle_plan
```

#### 5.5.4 実行前チェックリストの更新

警告がある場合のチェック項目を更新：

```python
checks = {
    "車庫が設定されている": depot_id is not None,
    "集積場所が設定されている": sink_id is not None,
    "車庫と集積場所が異なる": depot_id != sink_id if (depot_id and sink_id) else False,
    "回収地点が1箇所以上ある": len(pickup_selection) > 0,
    "全回収地点に資源種別が設定されている": all(
        pickup_id in st.session_state.get("pickup_attrs", {})
        for pickup_id in pickup_selection
    ) if pickup_selection else False,
    "車種が1種類以上設定されている": len(vehicles_defined) > 0,
    "車種割当プランが作成されている": len(vehicle_plan) > 0,
    "車種割当に警告がない": len(plan_warnings) == 0,
}
```

#### 5.5.5 警告の表示

車種割当に警告がある場合は、チェックリストで表示：

```python
# 警告がある場合は詳細を表示
if plan_warnings:
    st.markdown("---")
    st.subheader("⚠️ 車種割当の警告")
    for warning in plan_warnings:
        st.warning(warning, icon="⚠️")
    st.info("💡 警告を解消してから最適化を実行することを推奨します。")
```

#### 5.5.6 新しいタブ構造

```
タブ1: 📍 地点選択
├── 地図クリックモード選択
├── 地図表示
├── 回収地点ダイアログ（簡素化版）
└── 回収地点一覧（簡素化版）

タブ2: ⚡ 最適化実行
├── 車種割当プラン生成（内部実行）
├── 実行前チェックリスト
├── 車種割当警告表示（あれば）
├── 最適化ボタン
├── プログレスバー
└── 結果表示
```

#### 5.5.7 期待される効果
- **コード削減**: 約70行削除
- **タブ数削減**: 3タブ → 2タブ
- **認知負荷軽減**: 設定項目のないタブが消える
- **ワークフロー簡素化**: 地点選択 → 最適化実行のシンプルな流れ

---

## 6. データフロー設計

### 6.1 現在のデータフロー

```
[ユーザー入力]
    ↓
[タブ1: 地点選択]
    ├── 地図クリック → depot_id, sink_id
    ├── ダイアログ入力 → pickup_selection, pickup_attrs
    └── 手動選択 → (同上)
    ↓
[タブ2: 車種設定]
    ├── 車種編集 → vehicles
    ├── 回収地点入力 → pickup_attrs
    └── 車種割当プラン生成 → fleet_plan, vehicle_filter_warnings
    ↓
[タブ3: 最適化実行]
    ├── チェック実行
    ├── 最適化実行 → latest_solution
    └── 結果表示
```

### 6.2 簡素化後のデータフロー

```
[ユーザー入力]
    ↓
[タブ1: 地点選択]
    ├── 地図クリック → depot_id, sink_id
    └── ダイアログ入力（簡素化） → pickup_selection, pickup_attrs
    ↓
[タブ2: 最適化実行]
    ├── 車種割当プラン生成（自動） → fleet_plan, vehicle_filter_warnings
    ├── チェック実行
    ├── 最適化実行 → latest_solution
    └── 結果表示
```

### 6.3 セッション状態の変更

**削除される状態**: なし（全て保持）

**変更される状態**: なし（構造は維持）

**追加される状態**: なし

→ セッション状態の後方互換性は完全に保持

---

## 7. UI/UX設計

### 7.1 画面遷移図

#### 7.1.1 現在の画面遷移

```
[起動]
  ↓
[タブ1: 地点選択]
  ├── 地図をクリック
  ├── ダイアログ入力（詳細表示）
  ├── 選択状況確認（辞書形式）
  └── 手動選択（エクスパンダー）
  ↓
[タブ2: 車種設定]
  ├── 車種編集
  ├── 回収地点詳細入力
  └── 割当プラン確認
  ↓
[タブ3: 最適化実行]
  ├── チェックリスト確認
  ├── 実行ボタン
  └── 結果表示
```

#### 7.1.2 簡素化後の画面遷移

```
[起動]
  ↓
[タブ1: 地点選択]
  ├── 地図をクリック
  └── ダイアログ入力（シンプル）
  ↓
[タブ2: 最適化実行]
  ├── チェックリスト確認（自動生成）
  ├── 実行ボタン
  └── 結果表示
```

### 7.2 UI要素の変更

| 要素 | 変更前 | 変更後 |
|------|--------|--------|
| タブ数 | 3タブ | 2タブ |
| ダイアログ表示項目 | 7項目 | 2項目 |
| 選択状況表示 | サイドバー + メイン | サイドバーのみ |
| 手動選択 | あり | なし |
| 車種設定UI | 専用タブ | なし（内部処理） |

### 7.3 ユーザー操作フロー

#### 7.3.1 現在の操作フロー

```
1. タブ1で地図クリック（車庫、回収地点、集積場所）
2. 回収地点ダイアログで詳細入力
   - 回収量入力
   - 車種容量チェック確認
   - 資源種別選択
   - 適合車種確認
3. 選択状況を辞書形式で確認
4. (オプション) 手動選択で微調整
5. タブ2に移動
6. 車種を確認（編集可能）
7. 回収地点詳細を確認
8. 車種割当プランを確認
9. タブ3に移動
10. チェックリスト確認
11. 最適化実行
12. 結果確認

総クリック数: 約15-20回
```

#### 7.3.2 簡素化後の操作フロー

```
1. タブ1で地図クリック（車庫、回収地点、集積場所）
2. 回収地点ダイアログでシンプル入力
   - 回収量入力
   - 資源種別選択
3. (オプション) 回収地点一覧で編集
4. タブ2に移動
5. チェックリスト確認（自動生成）
6. 最適化実行
7. 結果確認

総クリック数: 約8-12回

削減率: 40-47%
```

---

## 8. 実装計画

### 8.1 実装スケジュール

| Phase | 内容 | 実装時間 | テスト時間 | リスク |
|-------|------|---------|----------|--------|
| Phase 3 | 選択状況表示削除 | 1分 | 5分 | 低 |
| Phase 4 | 手動選択削除 | 1分 | 5分 | 低 |
| Phase 1 | ダイアログ簡素化 | 10分 | 15分 | 中 |
| Phase 2 | 一覧簡素化 | 5分 | 10分 | 中 |
| Phase 5 | タブ削除 | 20分 | 30分 | 高 |
| **合計** | | **37分** | **65分** | |

**総実装時間**: 約1.5時間（実装37分 + テスト65分）

### 8.2 実装順序

#### ステップ1: 低リスク項目の実装
1. Phase 3実装 → テスト → コミット
2. Phase 4実装 → テスト → コミット

#### ステップ2: 中リスク項目の実装
3. Phase 1実装 → テスト → コミット
4. Phase 2実装 → テスト → コミット

#### ステップ3: 高リスク項目の実装
5. Phase 5実装 → テスト → コミット

#### ステップ4: 統合テスト
6. 全体フローのテスト
7. エッジケースのテスト
8. 最終確認

### 8.3 実装の前提条件

- [ ] 現在のコードのバックアップ作成
- [ ] ローカル開発環境の準備
- [ ] テストデータの準備
- [ ] ユーザーへの実装計画説明と承認

### 8.4 各Phaseの実装手順

#### Phase 3 & 4の実装手順

1. `src/app.py` を開く
2. Line 1371-1378を削除
3. Line 1380-1411を削除
4. ファイル保存
5. アプリ起動: `streamlit run src/app.py`
6. 動作確認
7. コミット: `git commit -m "UI簡素化: Phase 3, 4完了"`

#### Phase 1 & 2の実装手順

1. `src/app.py` を開く
2. `_render_pickup_dialog()`関数を修正
   - Lines 844-854削除
   - Lines 869-896削除
   - Line 840のhelpパラメータ削除
3. 回収地点一覧部分を修正
   - Lines 1279-1299削除
   - Lines 1350-1355削除
4. ファイル保存
5. アプリ起動とテスト
6. コミット: `git commit -m "UI簡素化: Phase 1, 2完了"`

#### Phase 5の実装手順

1. `src/app.py` を開く
2. Line 1164を修正（3タブ→2タブ）
3. Lines 1413-1485削除（タブ2全体）
4. タブ3をタブ2に変更
5. 車種割当プラン生成ロジックを追加
6. ファイル保存
7. アプリ起動とテスト
8. コミット: `git commit -m "UI簡素化: Phase 5完了"`

---

## 9. テスト計画

### 9.1 テスト戦略

#### 9.1.1 テストレベル

- **単体テスト**: なし（UIのため）
- **統合テスト**: 手動テスト
- **システムテスト**: E2Eシナリオテスト
- **受け入れテスト**: ユーザー確認

#### 9.1.2 テスト種別

- **機能テスト**: 全機能が正常動作
- **リグレッションテスト**: 既存機能が壊れていない
- **ユーザビリティテスト**: 操作性の向上確認

### 9.2 テストケース

#### 9.2.1 Phase 3 & 4のテスト

**テストケース1: 選択状況表示の確認**
- **前提条件**: アプリ起動
- **手順**:
  1. タブ1を開く
  2. 車庫を地図クリックで選択
  3. メインエリアを確認
- **期待結果**: 選択状況の辞書表示がない
- **確認方法**: 視覚的確認

**テストケース2: サイドバー表示の確認**
- **前提条件**: 上記テストの続き
- **手順**: サイドバーを確認
- **期待結果**: 選択状況が表示されている
- **確認方法**: 視覚的確認

**テストケース3: 手動選択エクスパンダーの確認**
- **前提条件**: タブ1を開く
- **手順**: 画面をスクロール
- **期待結果**: 「ノードを手動で選択」エクスパンダーがない
- **確認方法**: 視覚的確認

**テストケース4: 地図クリック選択の動作**
- **前提条件**: タブ1を開く
- **手順**:
  1. モード「車庫」を選択
  2. 地図をクリック
  3. モード「回収地点」を選択
  4. 地図をクリック
  5. モード「集積場所」を選択
  6. 地図をクリック
- **期待結果**: 各地点が正常に選択される
- **確認方法**: サイドバーの選択状況で確認

#### 9.2.2 Phase 1 & 2のテスト

**テストケース5: ダイアログのシンプル化確認**
- **前提条件**: タブ1を開く
- **手順**:
  1. モード「回収地点」を選択
  2. 地図をクリック
  3. ダイアログが表示される
- **期待結果**:
  - 回収量入力フィールドのみ（helpテキストなし）
  - 資源種別選択のみ
  - 車種容量チェック表示なし
  - 適合車種表示なし
- **確認方法**: 視覚的確認

**テストケース6: ダイアログでの追加操作**
- **前提条件**: ダイアログが開いている
- **手順**:
  1. 回収量に「500」を入力
  2. 資源種別を選択
  3. 「追加」ボタンをクリック
- **期待結果**:
  - 回収地点が追加される
  - ダイアログが閉じる
  - 回収地点一覧に表示される
- **確認方法**: 視覚的確認

**テストケース7: 回収地点一覧の簡素化確認**
- **前提条件**: 回収地点が1つ以上追加されている
- **手順**:
  1. 回収地点一覧のエクスパンダーを開く
- **期待結果**:
  - 資源種別と回収量のみ表示
  - 適合車種表示なし
  - 資源サマリー表示なし
- **確認方法**: 視覚的確認

**テストケース8: 回収地点の編集操作**
- **前提条件**: 回収地点一覧のエクスパンダーが開いている
- **手順**:
  1. 資源種別を変更
  2. 回収量を変更
  3. 「更新」ボタンをクリック
- **期待結果**:
  - 変更が反映される
  - 成功メッセージが表示される
- **確認方法**: 視覚的確認とセッション状態の確認

**テストケース9: 回収地点の削除操作**
- **前提条件**: 回収地点一覧のエクスパンダーが開いている
- **手順**: 「🗑️」ボタンをクリック
- **期待結果**:
  - 回収地点が削除される
  - 一覧から消える
- **確認方法**: 視覚的確認

#### 9.2.3 Phase 5のテスト

**テストケース10: タブ構造の確認**
- **前提条件**: アプリ起動
- **手順**: タブを確認
- **期待結果**:
  - タブが2つのみ（「📍 地点選択」「⚡ 最適化実行」）
  - 「🚗 2. 車種設定」タブがない
- **確認方法**: 視覚的確認

**テストケース11: 車種割当プラン自動生成の確認**
- **前提条件**:
  - 車庫、回収地点（資源種別設定済み）、集積場所が選択されている
- **手順**:
  1. タブ2「最適化実行」を開く
- **期待結果**:
  - チェックリストが表示される
  - 「車種割当プランが作成されている」がチェックされている
- **確認方法**: 視覚的確認

**テストケース12: 車種割当警告の表示**
- **前提条件**:
  - 回収地点で対応車種がない資源種別を選択
- **手順**:
  1. タブ2「最適化実行」を開く
- **期待結果**:
  - 警告が表示される
  - 「車種割当に警告がない」がチェックされていない
- **確認方法**: 視覚的確認

**テストケース13: 最適化実行**
- **前提条件**: 全てのチェック項目がクリア
- **手順**:
  1. 「最適化を実行」ボタンをクリック
  2. プログレスバーを確認
  3. 結果表示を待つ
- **期待結果**:
  - 最適化が正常に実行される
  - 結果が表示される
  - ルートと地図が表示される
- **確認方法**: 視覚的確認

#### 9.2.4 E2Eテストシナリオ

**シナリオ1: 正常系フルフロー**
1. アプリ起動
2. タブ1で車庫を地図クリック選択
3. タブ1で回収地点を地図クリック選択
   - ダイアログで回収量500kg、資源種別「建設廃材」を入力
   - 追加ボタンをクリック
4. タブ1で回収地点を地図クリック選択（2箇所目）
   - ダイアログで回収量300kg、資源種別「農業残渣」を入力
   - 追加ボタンをクリック
5. タブ1で集積場所を地図クリック選択
6. タブ2に移動
7. チェックリストを確認（全てクリア）
8. 「最適化を実行」ボタンをクリック
9. 結果を確認

**期待結果**: 全工程が問題なく完了し、最適化結果が表示される

**シナリオ2: 警告がある場合**
1. 上記手順1-5を実行
2. タブ2に移動
3. 警告が表示される（適合車種がない場合）
4. 最適化実行ボタンが無効化されている

**期待結果**: 警告が明確に表示され、実行がブロックされる

**シナリオ3: エラー処理**
1. タブ1で車庫と集積場所のみ選択（回収地点なし）
2. タブ2に移動
3. チェックリストで「回収地点が1箇所以上ある」が❌
4. 最適化実行ボタンが無効化されている

**期待結果**: エラー状態が明確に表示され、実行がブロックされる

### 9.3 テスト環境

- **OS**: Windows/Linux/macOS
- **Pythonバージョン**: 3.8以上
- **Streamlitバージョン**: 最新
- **ブラウザ**: Chrome, Firefox, Edge

### 9.4 テスト成功基準

- [ ] 全てのテストケースが合格
- [ ] E2Eシナリオが全て成功
- [ ] エラーやワーニングが発生しない
- [ ] レスポンス時間が現状と同等以上
- [ ] ユーザビリティの改善が体感できる

---

## 10. リスク管理

### 10.1 リスク一覧

| ID | リスク内容 | 発生確率 | 影響度 | リスクレベル | 対策 |
|----|----------|---------|--------|-------------|------|
| R1 | Phase 5でタブ構造変更時のバグ | 中 | 高 | 高 | 段階的実装とテスト |
| R2 | 車種割当プラン生成の失敗 | 低 | 高 | 中 | エラーハンドリング強化 |
| R3 | ユーザーが削除機能を求める | 低 | 中 | 低 | ユーザーフィードバック収集 |
| R4 | セッション状態の不整合 | 低 | 中 | 低 | 状態管理の確認 |
| R5 | 実装時間の超過 | 中 | 低 | 低 | バッファ時間確保 |

### 10.2 リスク対策詳細

#### R1: タブ構造変更時のバグ

**対策**:
- Phase 5を最後に実施
- 他のPhaseで十分にテスト
- コード変更前にバックアップ作成
- 段階的にコミット

**発生時の対処**:
- バックアップから復元
- 問題箇所を特定し修正
- 追加テストの実施

#### R2: 車種割当プラン生成の失敗

**対策**:
- エラーハンドリングを追加
```python
try:
    vehicle_plan, plan_warnings = _plan_vehicle_allocations(
        st.session_state["vehicles"],
        processed_master,
        pickup_inputs,
    )
except Exception as e:
    st.error(f"車種割当プランの生成に失敗しました: {e}")
    vehicle_plan = []
    plan_warnings = [f"エラー: {e}"]
```
- ログ出力の追加
- デフォルトプランの用意

**発生時の対処**:
- エラーメッセージをユーザーに表示
- ログからエラー原因を特定
- 必要に応じてロジック修正

#### R3: ユーザーが削除機能を求める

**対策**:
- ユーザーへの事前説明
- 削除機能の影響を説明
- フィードバック収集の仕組み

**発生時の対処**:
- ユーザー要望を詳細にヒアリング
- 必要性を判断
- 必要なら機能追加を検討

#### R4: セッション状態の不整合

**対策**:
- セッション状態の構造は変更しない
- 既存のキーは全て保持
- 状態の初期化コードは触らない

**発生時の対処**:
- セッション状態をクリア（ブラウザリロード）
- 状態管理コードの確認
- 必要に応じて修正

#### R5: 実装時間の超過

**対策**:
- スケジュールにバッファ50%を確保
- 各Phase完了後に進捗確認
- 問題発生時は早期エスカレーション

**発生時の対処**:
- 優先度の高いPhaseから実施
- 低リスクPhaseを先に完了
- ユーザーと調整

### 10.3 ロールバック計画

**ロールバック手順**:
1. Gitで以前のコミットを確認
   ```bash
   git log --oneline
   ```

2. 問題のあるコミットをリバート
   ```bash
   git revert <commit-hash>
   ```

3. または、特定のコミットにリセット
   ```bash
   git reset --hard <commit-hash>
   ```

4. アプリを再起動して動作確認
   ```bash
   streamlit run src/app.py
   ```

**ロールバック判断基準**:
- クリティカルなバグが発生
- 最適化機能が動作しない
- データの不整合が発生
- 修正に3時間以上かかる見込み

---

## 11. 品質保証

### 11.1 コード品質

#### 11.1.1 コーディング規約

- **PEP 8準拠**: Pythonコーディング規約に従う
- **型ヒント**: 関数の引数と戻り値に型ヒントを付与
- **ドキュメント文字列**: 全ての関数にdocstringを記載
- **命名規則**:
  - 関数: snake_case
  - クラス: PascalCase
  - 定数: UPPER_SNAKE_CASE

#### 11.1.2 コードレビュー

**レビュー項目**:
- [ ] 削除対象のコードが正しく削除されている
- [ ] 必要な機能が保持されている
- [ ] エラーハンドリングが適切
- [ ] コメントが適切に更新されている
- [ ] 不要なインポートがない
- [ ] デバッグコードが残っていない

#### 11.1.3 静的解析

```bash
# 型チェック
mypy src/app.py

# リンター
pylint src/app.py

# フォーマッター
black src/app.py
```

### 11.2 機能品質

#### 11.2.1 機能テストチェックリスト

- [ ] 地図クリックで地点選択ができる
- [ ] 回収地点ダイアログが表示される
- [ ] 回収地点が追加できる
- [ ] 回収地点一覧が表示される
- [ ] 回収地点の編集ができる
- [ ] 回収地点の削除ができる
- [ ] タブが2つ表示される
- [ ] 車種割当プランが自動生成される
- [ ] チェックリストが正しく表示される
- [ ] 最適化が実行できる
- [ ] 結果が表示される

#### 11.2.2 非機能テストチェックリスト

- [ ] レスポンス時間が許容範囲内
- [ ] メモリ使用量が適切
- [ ] エラーメッセージが分かりやすい
- [ ] UIが直感的
- [ ] 操作手順が明確

### 11.3 ユーザー受け入れ基準

- [ ] ユーザーが望むシンプルなフローが実現されている
- [ ] 不要な要素が削除されている
- [ ] 必要な機能が保持されている
- [ ] 操作性が向上している
- [ ] エラーが発生しない

---

## 12. 成果物

### 12.1 ドキュメント

| ドキュメント名 | パス | 内容 |
|--------------|------|------|
| UI簡素化分析レポート | `.claude/UI_SIMPLIFICATION_ANALYSIS.md` | 現状分析と問題点 |
| UI簡素化詳細設計書 | `docs/20251023_1834_UI簡素化詳細設計.md` | 本ドキュメント |
| テスト結果報告書 | `docs/20251023_XXXX_テスト結果報告.md` | テスト実施後に作成 |

### 12.2 コード成果物

| ファイル | 変更内容 | 行数削減 |
|---------|---------|---------|
| `src/app.py` | UI簡素化実装 | 約150-200行削減 |

### 12.3 成果指標

| 指標 | 変更前 | 変更後 | 改善率 |
|------|--------|--------|--------|
| タブ数 | 3 | 2 | -33% |
| ダイアログ表示項目 | 7 | 2 | -71% |
| 操作クリック数 | 15-20 | 8-12 | -40~47% |
| コード行数 | 1,631 | 1,450-1,480 | -9~11% |
| 画面表示要素数 | 多 | 少 | 定性的改善 |

### 12.4 Git履歴

**推奨コミットメッセージ**:

```bash
git commit -m "UI簡素化: Phase 3, 4完了 - 選択状況とノード手動選択の削除"
git commit -m "UI簡素化: Phase 1, 2完了 - ダイアログと一覧の簡素化"
git commit -m "UI簡素化: Phase 5完了 - 車種設定タブ削除と2タブ構造化"
git commit -m "UI簡素化: 全Phase完了 - テスト完了とドキュメント更新"
```

---

## 13. 付録

### 13.1 用語集

| 用語 | 説明 |
|------|------|
| **車庫** | 車両の出発・帰着地点 |
| **回収地点** | 資源を回収する地点 |
| **集積場所** | 回収した資源を集める場所 |
| **資源種別** | 回収する資源の種類（建設廃材、農業残渣など） |
| **回収量** | 各回収地点で回収する資源の重量（kg） |
| **車種割当プラン** | どの車種がどの資源を運ぶかの計画 |
| **最適化** | 最小コストでルートを計算する処理 |
| **セッション状態** | Streamlitでページ遷移間で保持されるデータ |

### 13.2 参照ドキュメント

| ドキュメント | パス |
|------------|------|
| システム構造分析 | `.claude/UI_STRUCTURE_ANALYSIS.md` |
| UIコンポーネント参照 | `.claude/UI_COMPONENTS_QUICK_REFERENCE.md` |
| UI改善詳細設計（旧） | `docs/20251023_0608_UI改善詳細設計.md` |

### 13.3 FAQ

**Q1: 車種の編集はできなくなるのか？**
A: 車種編集機能（`_render_vehicle_editor()`）は残っていますが、UIから直接アクセスできなくなります。車種はマスタデータ（`data/processed/vehicles.json`）で管理されます。

**Q2: 車種割当プランはどこで確認できるのか？**
A: タブ2「最適化実行」のチェックリストで、割当プランが作成されているかを確認できます。詳細な割当内容は表示されませんが、警告がある場合は表示されます。

**Q3: 削除した機能のバリデーションはどうなるのか？**
A: 車種容量や資源-車種適合のチェックは、最適化実行時にエラーとして表示されます。事前チェックから実行時チェックに変更されます。

**Q4: ロールバックは簡単にできるのか？**
A: はい、Gitでコミットを管理しているため、`git revert`または`git reset`で簡単に戻せます。

**Q5: Phase 5だけ後回しにできるのか？**
A: はい、Phase 1-4のみを実装して、Phase 5は別途実施することも可能です。各Phaseは独立しているため、段階的な適用が可能です。

---

## 14. 承認

### 14.1 設計レビュー

| 役割 | 氏名 | 日付 | 承認 |
|------|------|------|------|
| **設計者** | Claude Code | 2025-10-23 | ✓ |
| **レビュアー** | - | - | - |
| **承認者** | - | - | - |

### 14.2 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|----------|------|---------|--------|
| v1.0 | 2025-10-23 18:34 | 初版作成 | Claude Code |

---

**ドキュメント終了**
