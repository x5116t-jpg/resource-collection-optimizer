# 回収地点操作フロー改善 設計書

## 1. 背景
- ユーザーが回収地点を地図上で選択した際、ダイアログが閉じず追加結果が地図に即時反映されない。
- ダイアログを×で閉じた場合に内部状態が更新されず、次回クリック時に前回の地点が遅延して表示される。
- 成功トーストのみでフィードバックし、追加した地点へズーム・ハイライトされないため直感的でない。
- `src/ui/map_panel.py` が放置されており、地図描画ロジックが二重化している。

## 2. 改善目的
1. 「追加」クリック直後にダイアログが閉じ、地図にマーカーが表示される体験を実現する。
2. ダイアログを閉じる操作（×含む）に一貫して対応し、セッション状態の不整合を無くす。
3. 追加結果を視覚的に強調し、ユーザーに即時フィードバックを提供する。
4. 地図描画ロジックを単一のコードパスに集約し、保守性を高める。

## 3. 現状整理
- 地図描画 `_render_network_map` は `pickup_selection` の内容をもとにマーカーを描画 (`src/app.py:1319-1345`)。
- ダイアログ `_render_pickup_dialog` は `pickup_dialog_open` フラグが true の場合に描画 (`src/app.py:803-905`)。
- `追加` ボタン押下では `_finalise_pending_pickup` を呼び出し、セッション状態を書き換えた後 `_clear_pending_pickup` でフラグを折る (`src/app.py:229-244`)。ただし rerun 未実施。
- × クローズは Streamlit 標準ダイアログがハンドルせず、`pickup_dialog_open` が true のまま残るため、次回クリック時に警告 (`src/app.py:1364`)。
- `last_selected_node` はダイアログ表示時に `None` がセットされるが、地図再描画前に戻らない (`src/app.py:1381-1383`)。

## 4. 改善方針
### 4.1 セッション状態管理
- ダイアログ submit/cancel 時に専用のフラグ `pickup_dialog_result` を設定し、結果を `main()` 冒頭で処理してから地図を描画する。
- × で閉じたと判断するため、ダイアログ描画を試みたフレームで `pickup_dialog_open` が true のまま `pickup_dialog_rendered` が false ならキャンセル扱いにする。
- `_finalise_pending_pickup` 内で `last_selected_node` / `last_selected_role` を即時更新し、`pickup_selection` を返すことで後続処理に渡せるようにする。

### 4.2 rerun & レンダリング順序
- ダイアログ結果を `_process_pickup_dialog_result()` のような関数で処理し、`st.session_state["map_focus_token"]` に追加ノード ID を保存。
- 処理後に `st.rerun()` を発火させることで同一フレームで UI を再構築し、ダイアログ閉鎖と地図更新を保証。
- rerun に頼らずに即時反映する補助として、`selected_points` 作成直後に `map_focus_token` を参照し `last_feedback` を該当ノードに差し替えて中心化する。

### 4.3 UI フィードバック
- 地図セクション直上に `st.success` で「回収地点を追加しました: {label}」をオプション表示。
- `st.toast` は補完的に保持するが、追加直後は `map_focus_token` を用いてハイライト枠 (`ROLE_TO_COLOR`) を強調する。
- ダイアログキャンセル時は `st.info` を地図セクションに表示し、状態遷移が明確になるようにする。

### 4.4 地図描画コードの集約
- `src/ui/map_panel.py` の未使用関数を削除し、`app.py` 内の `_render_network_map` を唯一の描画手段と位置付ける。
- 将来の保守性確保のため、`_render_network_map` を `src/ui` 配下へ移すか、逆に `map_panel.py` を最新ロジックへ置換する案があるが、今回実装では不要部分の削除にとどめる。

## 5. 詳細設計
### 5.1 状態遷移図
```
CLICK → pending_pickup 設定 → pickup_dialog_open = True
  └─追加 submit→ pickup_dialog_result = {status: "add", node_id, qty, resource}
  └─キャンセル submit→ pickup_dialog_result = {status: "cancel"}
  └─×閉じ→ 次フレームで pickup_dialog_open==True & pickup_dialog_rendered==False → 同上 cancel
```

### 5.2 `_render_pickup_dialog` 変更点
- ダイアログ開始時に `st.session_state["pickup_dialog_rendered"] = True` をセット。
- `追加` ボタン時は `pickup_dialog_result` に辞書を格納、`pickup_dialog_open` を False にし rerun。
- `キャンセル` ボタン時および入力バリデーション失敗時も同様に `pickup_dialog_result` に status を格納。
- `_clear_pending_pickup()` は re-run 後に呼ぶため `pickup_dialog_open` と pending 情報を保持するが、`pickup_dialog_result` が処理済みになったタイミングでクリア。

### 5.3 `main()` 冒頭処理
- `_init_session_state` 後に `_process_pickup_dialog_result()` を新設し、`pickup_dialog_result` を検査。
    - status `add`: `_finalise_pending_pickup` を呼び、戻り値として追加ノード ID を受け取る。
    - status `cancel`: `_clear_pending_pickup()` で状態リセットし、地図セクションへ通知文字列を残す。
- 追加時は `st.session_state["map_focus_token"] = {"node_id": added_id, "role": "pickup"}` を保存。
- 処理完了後 `pickup_dialog_result` と `pickup_dialog_rendered` を削除。

### 5.4 `_finalise_pending_pickup` の見直し
- 返り値として `(node_id, attrs)` を返却可能にする。
- 処理内で `st.session_state["last_selected_node"] = node_id` と `last_selected_role = "pickup"` を設定。
- `_toast` 呼び出しは維持するが、成功時メッセージを `_process_pickup_dialog_result` からも利用できるようにする。

### 5.5 `_render_network_map` 修正
- `map_focus_token` が存在する場合、`last_feedback` を強制的に該当ノードへ置き換え、`folium.Map` の中心座標に使用。
- マーカー描画時に最新追加ノードの場合は枠色をゴールド、サイズを拡張。

### 5.6 キャンセル / × 閉じ検知
- `main()` 内で `_render_pickup_dialog` 呼び出し前に `st.session_state.setdefault("pickup_dialog_rendered", False)`。
- `_render_pickup_dialog` が呼ばれないまま `pickup_dialog_open` が True なら、自動的に cancel として処理。
- フォームバリデーション失敗時は rerun せず、エラーメッセージ表示のみ。

### 5.7 不要モジュール整理
- `src/ui/map_panel.py` が未使用であることを確認済み (`rg 'render_map'` 等で参照なし)。本改善と同時に削除し、UI コードの重複を排除。

## 6. 実装手順 (概要)
1. セッション状態キー追加 (`pickup_dialog_result`, `pickup_dialog_rendered`, `map_focus_token`).
2. `_process_pickup_dialog_result` を実装し、`main()` 冒頭で呼び出し。
3. `_finalise_pending_pickup` をリファクタリングし、返り値・`last_selected_*` 更新を追加。
4. `_render_pickup_dialog` の submit ハンドリングを `pickup_dialog_result` ベースへ変更。
5. `_render_network_map` にフォーカス・ハイライト機能を追加。
6. `src/ui/map_panel.py` を削除し、関連参照を除去。
7. 新旧動作のリグレッションを防ぐためのテストを実施。

## 7. テスト観点
- 正常系: 回収地点追加 → ダイアログ即閉・マーカー即表示・メッセージ表示。
- キャンセル系: ダイアログでキャンセル → マーカー非追加・通知表示。
- × 閉じ: ダイアログを閉じた後、次のクリックで警告が出ず新規地点が追加できる。
- 既存バリデーション: 0kg 入力で警告が表示され rerun せずダイアログ継続。
- 複数追加: 連続で別地点を追加し、毎回フォーカスが新地点に遷移する。
- 再起動後セッション: `map_focus_token` 等が初期化され既存表示に影響しない。

## 8. 影響範囲
- `src/app.py` の地点選択フロー（セッション状態管理、地図描画）。
- `src/ui/map_panel.py` の削除に伴う import/参照（今回参照なしの確認済み）。
- Streamlit rerun の発火頻度が増えるため、パフォーマンスへの影響は軽微と想定。

## 9. 今後の改善余地
- map UI を `st_folium` から純粋な `pydeck` へ差し替える案の検討。
- 地図サイドバーで選択履歴をタイムライン表示し、追加地点のフィードバックを強化。
- rerun 頻度を減らすため、`st.session_state` を直接書き換える代わりに `st.experimental_data_editor` 等のイベントフック採用を検討。

